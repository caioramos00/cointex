{% load theming %}{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, viewport-fit=cover" />
  <title>Ajuda com acesso — MPay</title>

  <link rel="icon" href="{% themed_static 'images/logo/favicon.png' %}" type="image/png" />
  <link rel="apple-touch-icon" href="{% themed_static 'images/logo/favicon.png' %}" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% themed_static 'css/vendors/bootstrap.min.css' %}" />
  <link rel="stylesheet" href="{% themed_static 'css/vendors/swiper-bundle.min.css' %}" />
  <link rel="stylesheet" href="{% themed_static 'css/style.css' %}" />
  <link rel="stylesheet" href="{% themed_static 'css/overrides.css' %}" />
</head>

<body class="mpay-theme auth-body">
  <!-- HEADER (baseado no Help.html) -->
  <div class="auth-header">
    <div class="help-head d-flex">
      <a href="{% url 'accounts:login' %}" class="back-btn"><i class="back-btn" data-feather="arrow-left"></i></a>
      <h2>Ajuda com acesso</h2>
    </div>
    <div class="head-img text-center">
      <img class="img-fluid img2" src="{% themed_static 'images/authentication/help.svg' %}" alt="Ajuda" />
    </div>
  </div>

  {% if not submitted %}
  <!-- ===== ESTADO: FORM ===== -->
  <section class="section-t-space">
    <div class="custom-container">
      <h4 class="fw-normal light-text lh-base">
        Informe seu <strong>e-mail cadastrado</strong> ou <strong>telefone</strong> para receber instruções.
      </h4>

      <form method="post" class="auth-form theme-form pt-0 mt-3">
        {% csrf_token %}
        <div class="form-group">
          <label for="email_or_phone" class="form-label">E-mail ou telefone</label>
          <input
            type="text"
            id="email_or_phone"
            name="email_or_phone"
            class="form-control"
            placeholder="exemplo@mpaybank.cash ou (00) 00000-0000"
            inputmode="text"
            autocomplete="email tel"
            enterkeyhint="done"
            required
          />
        </div>

        <button class="btn theme-btn w-100" type="submit"
                onclick="try{fbq('trackCustom','PasswordHelpSubmit')}catch(e){}">
          Enviar instruções
        </button>

        <h4 class="signup mt-3">Lembrou a senha? <a href="{% url 'accounts:login' %}">Entrar</a></h4>
      </form>
    </div>
  </section>

  {% else %}
  <!-- ===== ESTADO: SUCESSO ===== -->
  <section class="section-b-space">
    <div class="custom-container">
      <div class="successfully-pay text-center my-1" style="margin: 8px auto 12px !important;">
        <img class="img-fluid pay-img" src="{% themed_static 'images/gif/successfull-payment.gif' %}" alt="Sucesso"
             style="max-width: 120px !important;" />
      </div>

      <div class="text-center mb-3">
        <h4>Caso os dados informados estiverem corretos, enviaremos um link para redefinir a senha</h4>
      </div>

      <a href="{% url 'accounts:login' %}" class="btn theme-btn successfully w-100 mb-2">Voltar ao login</a>
    </div>
  </section>
  {% endif %}

  <!-- JS -->
  <script src="{% themed_static 'js/feather.min.js' %}"></script>
  <script src="{% themed_static 'js/custom-feather.js' %}"></script>
  <script src="{% themed_static 'js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% themed_static 'js/script.js' %}"></script>
  <script src="https://unpkg.com/imask"></script>

  <!-- Placeholder sempre visível e máscara dinâmica para telefone -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // mantém placeholder visível mesmo no foco
      document.querySelectorAll('.auth-form .form-control[placeholder]').forEach(function (el) {
        el.dataset.ph = el.getAttribute('placeholder');
        ['focus', 'blur', 'input'].forEach(evt => el.addEventListener(evt, function(){
          if (!this.getAttribute('placeholder')) this.setAttribute('placeholder', this.dataset.ph);
        }));
      });

      // email/telefone dinâmico com IMask (BR)
      var el = document.getElementById('email_or_phone');
      if (!el) return;

      var phoneMask = null; // instância ativa de máscara

      function isLikelyPhone(v){
        v = (v || '').trim();
        // só dígitos e sinais? (provável telefone)
        if (/^[\d\s()+-]+$/.test(v)) return true;
        // começa digitando número
        if (/^\d/.test(v)) return true;
        return false;
      }

      function ensurePhoneMask(){
        if (phoneMask) return;
        phoneMask = IMask(el, {
          mask: [
            // celular (11 dígitos no BR)
            { mask: '(00) 00000-0000' },
            // fixo (10 dígitos)
            { mask: '(00) 0000-0000' },
            // internacional simples +55 ...
            { mask: '+00 (00) 00000-0000' },
            { mask: '+00 (00) 0000-0000' }
          ],
          dispatch: function (appended, masked){
            var number = (masked.value + appended).replace(/\D/g,'');
            if (masked.value.startsWith('+')) {
              return number.length > 12 ? masked.compiledMasks[2] : masked.compiledMasks[3];
            }
            return number.length > 10 ? masked.compiledMasks[0] : masked.compiledMasks[1];
          }
        });
        el.setAttribute('inputmode','tel');
        el.setAttribute('enterkeyhint','done');
      }

      function destroyPhoneMask(){
        if (!phoneMask) return;
        phoneMask.destroy();
        phoneMask = null;
        el.setAttribute('inputmode','email');
      }

      // alterna automaticamente
      el.addEventListener('input', function(){
        if (isLikelyPhone(this.value)) { ensurePhoneMask(); }
        else { destroyPhoneMask(); }
      });

      // estado inicial
      if (isLikelyPhone(el.value)) ensurePhoneMask();
      else destroyPhoneMask();
    });
  </script>
</body>
</html>
