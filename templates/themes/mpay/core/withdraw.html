{% load theming %}
{% load static %}
{% load tracking_tags %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="mpay" />
  <meta name="keywords" content="mpay" />
  <meta name="author" content="mpay" />
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <link rel="icon" href="{% themed_static 'images/logo/favicon.png' %}" type="image/x-icon" />
  <title>mPay App - Saque</title>
  <link rel="apple-touch-icon" href="{% themed_static 'images/logo/favicon.png' %}" />
  <meta name="theme-color" content="#122636" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="mpay" />
  <meta name="msapplication-TileImage" content="{% themed_static 'images/logo/favicon.png' %}" />
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  {% tracking_head %}

  <!-- Google font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;700;900&display=swap" rel="stylesheet" />

  <!-- bootstrap css -->
  <link rel="stylesheet" id="rtl-link" type="text/css" href="{% themed_static 'css/vendors/bootstrap.min.css' %}" />

  <!-- swiper css -->
  <link rel="stylesheet" type="text/css" href="{% themed_static 'css/vendors/swiper-bundle.min.css' %}" />

  <!-- Theme css -->
  <link rel="stylesheet" id="change-link" type="text/css" href="{% themed_static 'css/style.css' %}" />

  <style>
    /* estado de erro do campo de valor */
    .input-group.field-error .form-control,
    .input-group.field-error .input-group-text {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 0.08rem rgba(220, 53, 69, 0.4);
    }

    .amount-error-text {
      color: #dc3545;
      font-size: 0.8rem;
      margin-top: 4px;
      display: none;
    }

    /* bloco de confirmação */
    .transaction-preview {
      display: none;
      margin-top: 18px;
      padding: 16px 14px;
      border-radius: 12px;
      background-color: #f8f9fa;
    }

    .transaction-preview .preview-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .transaction-preview .preview-row {
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    .transaction-preview .preview-row span.label {
      font-weight: 600;
    }

    .transaction-preview .btn {
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <!-- header start -->
  <header class="section-t-space">
    <div class="custom-container">
      <div class="header-panel">
        <a href="{% url 'core:home' %}" class="back-btn">
          <i class="icon" data-feather="arrow-left"></i>
        </a>
        <h2>Sacar</h2>
      </div>
    </div>
  </header>
  <!-- header end -->

  <!-- Withdraw section starts -->
  <section class="section-b-space">
    <div class="custom-container">
      <div class="title" style="margin-bottom: 0px;">
        <label for="inputbankname" class="form-label">Origem do saque</label>
      </div>

      <ul class="select-bank" style="margin-bottom: 6px;">
        <!-- CARD 1: SALDO REAL DO USUÁRIO -->
        <li>
          <div class="balance-box active">
            <input
              class="form-check-input"
              type="radio"
              name="flexRadio"
              id="origin-balance"
              value="balance"
              checked />
            <img class="img-fluid balance-box-img active"
                 src="{% themed_static 'images/svg/balance-box-bg-active.svg' %}"
                 alt="caixa-saldo-ativo" />
            <img class="img-fluid balance-box-img unactive"
                 src="{% themed_static 'images/svg/balance-box-bg.svg' %}"
                 alt="caixa-saldo" />
            <div class="balance-content">
              <h6>Saldo atual</h6>
              <h3 id="balanceValue">R$ {{ formatted_balance|default:"0,00" }}</h3>
              <h5>Disponível para saque</h5>
            </div>
          </div>
        </li>

        <!-- CARD 2: LIMITE DO CARTÃO DE CRÉDITO -->
        <li>
          <div class="balance-box">
            <input
              class="form-check-input"
              type="radio"
              name="flexRadio"
              id="origin-credit"
              value="credit" />
            <img class="img-fluid balance-box-img active"
                 src="{% themed_static 'images/svg/balance-box-bg-active.svg' %}"
                 alt="caixa-limite-ativo" />
            <img class="img-fluid balance-box-img unactive"
                 src="{% themed_static 'images/svg/balance-box-bg.svg' %}"
                 alt="caixa-limite" />
            <div class="balance-content">
              <h6>Cartão de crédito</h6>
              <h3 id="creditLimitValue">{{ credit_limit_formatted|default:"R$ 0,00" }}</h3>
              <h5>**** **** **** 2563</h5>
            </div>
          </div>
        </li>
      </ul>

      <!-- FORM -->
      <form class="auth-form p-0" target="_blank" id="withdrawForm">
        <!-- MÉTODO DE SAQUE -->
        <div class="form-group">
          <label for="inputbankname" class="form-label" style="margin-top: 10px;">Método de Saque</label>
          <select id="inputbankname" class="form-select">
            <option>PIX</option>
            <option disabled>Transferência (TED)</option>
          </select>
        </div>

        <!-- TIPO DE CHAVE PIX -->
        <div class="form-group">
          <label for="pixKeyType" class="form-label">Tipo de Chave PIX</label>
          <select id="pixKeyType" class="form-select">
            <option value="" disabled selected>Selecione o tipo de chave</option>
            <option value="phone">Número de Telefone</option>
            <option value="email">E-mail</option>
            <option value="cpf">CPF</option>
            <option value="cnpj">CNPJ</option>
            <option value="random">Chave Aleatória</option>
          </select>
        </div>

        <!-- CHAVE PIX -->
        <div class="form-group" id="pixKeyContainer" style="display: none;">
          <label for="pixKey" class="form-label">Chave PIX</label>
          <input
            type="text"
            class="form-control"
            id="pixKey"
            placeholder="Digite a chave PIX" />
        </div>

        <!-- VALOR -->
        <div class="form-group">
          <label for="inputamount" class="form-label">Valor</label>
          <div class="input-group" id="amountGroup">
            <span class="input-group-text" id="amountAddon">R$</span>
            <input
              type="tel"
              inputmode="decimal"
              class="form-control"
              id="inputamount"
              placeholder="0,00" />
          </div>
          <small id="amountError" class="amount-error-text"></small>
        </div>

        <!-- Botão começa desativado -->
        <button
          type="button"
          class="btn theme-btn w-100"
          id="withdrawButton"
          disabled>
          Sacar
        </button>
      </form>

      <!-- PREVIEW / CONFIRMAÇÃO -->
      <div class="transaction-preview" id="transactionPreview">
        <div class="preview-title">Confirme os dados</div>

        <div class="preview-row">
          <span class="label">Origem:</span>
          <span id="previewOrigin"></span>
        </div>
        <div class="preview-row">
          <span class="label">Tipo de chave PIX:</span>
          <span id="previewPixType"></span>
        </div>
        <div class="preview-row">
          <span class="label">Chave PIX:</span>
          <span id="previewPixKey"></span>
        </div>
        <div class="preview-row">
          <span class="label">Valor a sacar:</span>
          R$ <span id="previewAmount">0,00</span>
        </div>
        <div class="preview-row">
          <span class="label">Valor final (após taxa):</span>
          R$ <span id="previewNetAmount">0,00</span>
        </div>

        <button type="button" class="btn theme-btn w-100" id="confirmWithdrawBtn">
          Confirmar saque
        </button>
        <button type="button" class="btn btn-outline-secondary w-100" id="editWithdrawBtn">
          Editar dados
        </button>
      </div>
    </div>
  </section>
  <!-- Withdraw section end -->

  <!-- successful transfer modal start -->
  <div class="modal successful-modal fade" id="done" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Transferência realizada com sucesso</h2>
        </div>
        <div class="modal-body">
          <div class="done-img">
            <img class="img-fluid" src="{% themed_static 'images/svg/done.svg' %}" alt="concluído" />
          </div>
          <h2>R$ 49,85</h2>
          <h3>O dinheiro foi sacado com sucesso de **63 para **47</h3>
          <a href="{% url 'core:home' %}" class="btn theme-btn successfully w-100">Voltar para a tela inicial</a>
        </div>
        <button type="button" class="btn close-btn" data-bs-dismiss="modal">
          <i class="icon" data-feather="x"></i>
        </button>
      </div>
    </div>
  </div>
  <!-- successful transfer modal end -->

  <!-- feather js -->
  <script src="{% themed_static 'js/feather.min.js' %}"></script>
  <script src="{% themed_static 'js/custom-feather.js' %}"></script>

  <!-- bootstrap js -->
  <script src="{% themed_static 'js/bootstrap.bundle.min.js' %}"></script>

  <!-- jQuery + máscara -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

  <script>
    $(document).ready(function () {
      const $amount = $('#inputamount');
      const $amountGroup = $('#amountGroup');
      const $amountAddon = $('#amountAddon');
      const $amountError = $('#amountError');

      const $pixKeyType = $('#pixKeyType');
      const $pixKey = $('#pixKey');
      const $pixKeyContainer = $('#pixKeyContainer');

      const $withdrawButton = $('#withdrawButton');
      const $originRadios = $('input[name="flexRadio"]');
      const $balanceValueEl = $('#balanceValue');
      const $creditLimitValueEl = $('#creditLimitValue');

      const $form = $('#withdrawForm');
      const $transactionPreview = $('#transactionPreview');
      const feePercentage = {{ fee_percentage|default:"0" }} / 100;

      // Força teclado numérico para o valor + máscara BRL
      $amount.attr('type', 'tel').attr('inputmode', 'decimal');
      $amount.mask('000.000.000,00', { reverse: true });

      // Helper: texto BRL -> float
      function parseBRLToFloat(str) {
        if (!str) return 0;
        return parseFloat(
          str.toString()
            .replace(/\s/g, '')
            .replace('R$', '')
            .replace(/\./g, '')
            .replace(',', '.')
        ) || 0;
      }

      // Limite de acordo com origem
      function getCurrentAvailableLimit() {
        const origin = $('input[name="flexRadio"]:checked').val();
        if (origin === 'credit') {
          return {
            numeric: parseBRLToFloat($creditLimitValueEl.text()),
            formatted: $creditLimitValueEl.text()
          };
        }
        return {
          numeric: parseBRLToFloat($balanceValueEl.text()),
          formatted: $balanceValueEl.text()
        };
      }

      // Limpa erro visual
      function clearAmountError() {
        $amountGroup.removeClass('field-error');
        $amountError.text('').hide();
        $amount.css({ 'border-color': '', 'box-shadow': '' });
        $amountAddon.css({ 'border-color': '', 'box-shadow': '' });
      }

      // Mostra erro visual (campo inteiro)
      function showAmountError(message) {
        $amountGroup.addClass('field-error');
        $amountError.text(message).show();
        $amount.css({
          'border-color': '#dc3545',
          'box-shadow': '0 0 0 0.08rem rgba(220, 53, 69, 0.4)'
        });
        $amountAddon.css({
          'border-color': '#dc3545',
          'box-shadow': '0 0 0 0.08rem rgba(220, 53, 69, 0.4)'
        });
      }

      // Validação "visual" do valor
      function validateAmount() {
        const raw = $amount.val();

        if (!raw) {
          showAmountError('Informe um valor para saque.');
          return false;
        }

        const numericAmount = parseFloat(
          raw.replace(/\./g, '').replace(',', '.')
        ) || 0;

        if (numericAmount <= 0) {
          showAmountError('Informe um valor maior que zero.');
          return false;
        }

        const limit = getCurrentAvailableLimit();

        if (numericAmount > limit.numeric) {
          showAmountError('Valor máximo para esta origem é ' + limit.formatted + '.');
          return false;
        }

        clearAmountError();
        return true;
      }

      // Validação simples (sem mexer na UI)
      function isAmountValidSimple() {
        const raw = $amount.val();
        if (!raw) return false;

        const numericAmount = parseFloat(
          raw.replace(/\./g, '').replace(',', '.')
        ) || 0;
        if (numericAmount <= 0) return false;

        const limit = getCurrentAvailableLimit();
        if (numericAmount > limit.numeric) return false;

        return true;
      }

      // Validação da chave PIX
      function isPixKeyValid() {
        const type = $pixKeyType.val();
        if (!type) return false;

        const value = ($pixKey.val() || '').trim();
        if (!value) return false;

        if (type === 'phone') {
          return /^\(\d{2}\)\s\d{5}-\d{4}$/.test(value);
        }
        if (type === 'cpf') {
          return /^\d{3}\.\d{3}\.\d{3}-\d{2}$/.test(value);
        }
        if (type === 'cnpj') {
          return /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/.test(value);
        }
        if (type === 'email') {
          return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
        }
        if (type === 'random') {
          return value.length > 0;
        }
        return false;
      }

      // Atualiza estado do botão Sacar
      function updateWithdrawButton() {
        const canWithdraw = isAmountValidSimple() && isPixKeyValid();
        $withdrawButton.prop('disabled', !canWithdraw);
      }

      // Tipo de chave PIX
      $pixKeyType.on('change', function () {
        const type = $(this).val();

        $pixKeyContainer.show();

        // limpa valor/máscara
        $pixKey.val('');
        if (typeof $pixKey.unmask === 'function') {
          $pixKey.unmask();
        }

        $pixKey.attr('type', 'text').removeAttr('inputmode');

        switch (type) {
          case 'phone':
            $pixKey.attr('type', 'tel').attr('inputmode', 'numeric');
            $pixKey.mask('(00) 00000-0000');
            break;
          case 'cpf':
            $pixKey.attr('type', 'tel').attr('inputmode', 'numeric');
            $pixKey.mask('000.000.000-00');
            break;
          case 'cnpj':
            $pixKey.attr('type', 'tel').attr('inputmode', 'numeric');
            $pixKey.mask('00.000.000/0000-00');
            break;
          case 'email':
            $pixKey.attr('type', 'email').attr('inputmode', 'email');
            break;
          case 'random':
            $pixKey.attr('type', 'text');
            break;
        }

        updateWithdrawButton();
      });

      // Mudança de origem -> revalida
      $originRadios.on('change', function () {
        if ($amount.val()) {
          validateAmount();
        }
        updateWithdrawButton();
      });

      // Digitação do valor
      $amount.on('input', function () {
        if ($amount.val()) {
          validateAmount();
        } else {
          clearAmountError();
        }
        updateWithdrawButton();
      });

      // Digitação da chave PIX
      $pixKey.on('input', function () {
        updateWithdrawButton();
      });

      // Preencher preview
      function fillPreview() {
        const originVal = $('input[name="flexRadio"]:checked').val();
        const originLabel = originVal === 'credit' ? 'Cartão de crédito' : 'Saldo da conta';

        const rawAmount = $amount.val();
        const amountNumeric = parseFloat(
          rawAmount.replace(/\./g, '').replace(',', '.')
        ) || 0;

        const netAmount = amountNumeric * (1 - feePercentage);

        const pixTypeVal = $pixKeyType.val();
        const pixTypeLabelMap = {
          phone: 'Número de Telefone',
          email: 'E-mail',
          cpf: 'CPF',
          cnpj: 'CNPJ',
          random: 'Chave Aleatória'
        };

        $('#previewOrigin').text(originLabel);
        $('#previewPixType').text(pixTypeLabelMap[pixTypeVal] || '-');
        $('#previewPixKey').text($pixKey.val());

        $('#previewAmount').text(
          amountNumeric.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        );
        $('#previewNetAmount').text(
          netAmount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        );
      }

      // Mostrar tela de confirmação
      function showPreview() {
        if (!validateAmount() || !isPixKeyValid()) {
          return;
        }
        fillPreview();
        $form.hide();
        $transactionPreview.show();
      }

      // Voltar para edição
      $('#editWithdrawBtn').on('click', function () {
        $transactionPreview.hide();
        $form.show();
      });

      // Clique em Sacar -> vai para preview
      $withdrawButton.on('click', function () {
        showPreview();
      });

      // Confirmar saque -> abre modal de sucesso (por enquanto front-only)
      $('#confirmWithdrawBtn').on('click', function () {
        const modal = new bootstrap.Modal(document.getElementById('done'));
        modal.show();
      });

      // estado inicial
      updateWithdrawButton();
    });
  </script>

  {% tracking_body_end %}
</body>

</html>
