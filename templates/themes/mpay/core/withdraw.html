{% load theming %}
{% load static %}
{% load tracking_tags %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="mpay" />
  <meta name="keywords" content="mpay" />
  <meta name="author" content="mpay" />
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <link rel="icon" href="{% themed_static 'images/logo/favicon.png' %}" type="image/x-icon" />
  <title>mPay App - Saque</title>
  <link rel="apple-touch-icon" href="{% themed_static 'images/logo/favicon.png' %}" />
  <meta name="theme-color" content="#122636" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="mpay" />
  <meta name="msapplication-TileImage" content="{% themed_static 'images/logo/favicon.png' %}" />
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  {% tracking_head %}

  <!-- Google font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;700;900&display=swap" rel="stylesheet" />

  <!-- bootstrap css -->
  <link rel="stylesheet" id="rtl-link" type="text/css" href="{% themed_static 'css/vendors/bootstrap.min.css' %}" />

  <!-- swiper css -->
  <link rel="stylesheet" type="text/css" href="{% themed_static 'css/vendors/swiper-bundle.min.css' %}" />

  <!-- Theme css -->
  <link rel="stylesheet" id="change-link" type="text/css" href="{% themed_static 'css/style.css' %}" />

  <style>
    /* borda vermelha temporária no campo de valor */
    .field-error {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 0.08rem rgba(220, 53, 69, 0.4);
    }
    .field-error-addon {
      border-color: #dc3545 !important;
    }
    .amount-error-text {
      color: #dc3545;
      font-size: 0.8rem;
      margin-top: 4px;
      display: none;
    }
  </style>
</head>

<body>
  <!-- header start -->
  <header class="section-t-space">
    <div class="custom-container">
      <div class="header-panel">
        <a href="{% url 'core:home' %}" class="back-btn">
          <i class="icon" data-feather="arrow-left"></i>
        </a>
        <h2>Sacar</h2>
      </div>
    </div>
  </header>
  <!-- header end -->

  <!-- Withdraw section starts -->
  <section class="section-b-space">
    <div class="custom-container">
      <div class="title" style="margin-bottom: 0px;">
        <label for="inputbankname" class="form-label">Origem do saque</label>
      </div>

      <ul class="select-bank" style="margin-bottom: 6px;">
        <!-- CARD 1: SALDO REAL DO USUÁRIO -->
        <li>
          <div class="balance-box active">
            <input
              class="form-check-input"
              type="radio"
              name="flexRadio"
              id="origin-balance"
              value="balance"
              checked />
            <img class="img-fluid balance-box-img active"
                 src="{% themed_static 'images/svg/balance-box-bg-active.svg' %}"
                 alt="caixa-saldo-ativo" />
            <img class="img-fluid balance-box-img unactive"
                 src="{% themed_static 'images/svg/balance-box-bg.svg' %}"
                 alt="caixa-saldo" />
            <div class="balance-content">
              <h6>Saldo atual</h6>
              <!-- formatted_balance vem da view e é só o número (ex.: 1.234,56) -->
              <h3 id="balanceValue">R$ {{ formatted_balance|default:"0,00" }}</h3>
              <h5>Disponível para saque</h5>
            </div>
          </div>
        </li>

        <!-- CARD 2: LIMITE DO CARTÃO DE CRÉDITO -->
        <li>
          <div class="balance-box">
            <input
              class="form-check-input"
              type="radio"
              name="flexRadio"
              id="origin-credit"
              value="credit" />
            <img class="img-fluid balance-box-img active"
                 src="{% themed_static 'images/svg/balance-box-bg-active.svg' %}"
                 alt="caixa-limite-ativo" />
            <img class="img-fluid balance-box-img unactive"
                 src="{% themed_static 'images/svg/balance-box-bg.svg' %}"
                 alt="caixa-limite" />
            <div class="balance-content">
              <h6>Cartão de crédito</h6>
              <!-- credit_limit_formatted já vem com "R$ ..." da view -->
              <h3 id="creditLimitValue">{{ credit_limit_formatted|default:"R$ 0,00" }}</h3>
              <h5>**** **** **** 2563</h5>
            </div>
          </div>
        </li>
      </ul>

      <form class="auth-form p-0" target="_blank">
        <!-- MÉTODO DE SAQUE -->
        <div class="form-group">
          <label for="inputbankname" class="form-label" style="margin-top: 10px;">Método de Saque</label>
          <select id="inputbankname" class="form-select">
            <option>PIX</option>
            <option disabled>Transferência (TED)</option>
          </select>
        </div>

        <!-- TIPO DE CHAVE PIX -->
        <div class="form-group">
          <label for="pixKeyType" class="form-label">Tipo de Chave PIX</label>
          <select id="pixKeyType" class="form-select">
            <option value="" disabled selected>Selecione o tipo de chave</option>
            <option value="phone">Número de Telefone</option>
            <option value="email">E-mail</option>
            <option value="cpf">CPF</option>
            <option value="cnpj">CNPJ</option>
            <option value="random">Chave Aleatória</option>
          </select>
        </div>

        <!-- CHAVE PIX (aparece só depois de escolher o tipo) -->
        <div class="form-group" id="pixKeyContainer" style="display: none;">
          <label for="pixKey" class="form-label">Chave PIX</label>
          <input
            type="text"
            class="form-control"
            id="pixKey"
            placeholder="Digite a chave PIX" />
        </div>

        <!-- VALOR COM MÁSCARA BRL E TECLADO NUMÉRICO -->
        <div class="form-group">
          <label for="inputamount" class="form-label">Valor</label>
          <div class="input-group">
            <span class="input-group-text" id="amountAddon">R$</span>
            <input
              type="tel"
              inputmode="decimal"
              class="form-control"
              id="inputamount"
              placeholder="0,00" />
          </div>
          <small id="amountError" class="amount-error-text"></small>
        </div>

        <a href="#done" class="btn theme-btn w-100" id="withdrawButton" data-bs-toggle="modal">Sacar</a>
      </form>
    </div>
  </section>
  <!-- Withdraw section end -->

  <!-- successful transfer modal start -->
  <div class="modal successful-modal fade" id="done" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Transferência realizada com sucesso</h2>
        </div>
        <div class="modal-body">
          <div class="done-img">
            <img class="img-fluid" src="{% themed_static 'images/svg/done.svg' %}" alt="concluído" />
          </div>
          <h2>R$ 49,85</h2>
          <h3>O dinheiro foi sacado com sucesso de **63 para **47</h3>
          <a href="{% url 'core:home' %}" class="btn theme-btn successfully w-100">Voltar para a tela inicial</a>
        </div>
        <button type="button" class="btn close-btn" data-bs-dismiss="modal">
          <i class="icon" data-feather="x"></i>
        </button>
      </div>
    </div>
  </div>
  <!-- successful transfer modal end -->

  <!-- feather js -->
  <script src="{% themed_static 'js/feather.min.js' %}"></script>
  <script src="{% themed_static 'js/custom-feather.js' %}"></script>

  <!-- bootstrap js -->
  <script src="{% themed_static 'js/bootstrap.bundle.min.js' %}"></script>

  <!-- jQuery + máscara -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

  <script>
    $(document).ready(function () {
      const $amount = $('#inputamount');
      const $amountAddon = $('#amountAddon');
      const $pixKeyType = $('#pixKeyType');
      const $pixKey = $('#pixKey');
      const $pixKeyContainer = $('#pixKeyContainer');
      const $amountError = $('#amountError');
      const $withdrawButton = $('#withdrawButton');

      const $originRadios = $('input[name="flexRadio"]');
      const $balanceValueEl = $('#balanceValue');
      const $creditLimitValueEl = $('#creditLimitValue');

      let amountErrorTimeout = null;

      // Força teclado numérico para o valor
      $amount.attr('type', 'tel').attr('inputmode', 'decimal');
      // Máscara BRL 000.000.000,00
      $amount.mask('000.000.000,00', { reverse: true });

      // Função auxiliar para converter BRL ("R$ 1.234,56") para float
      function parseBRLToFloat(str) {
        if (!str) return 0;
        return parseFloat(
          str
            .toString()
            .replace(/\s/g, '')       // remove espaços
            .replace('R$', '')        // remove símbolo
            .replace(/\./g, '')       // remove separador de milhar
            .replace(',', '.')        // vírgula -> ponto
        ) || 0;
      }

      // Retorna o limite atual de acordo com a origem selecionada
      function getCurrentAvailableLimit() {
        const origin = $('input[name="flexRadio"]:checked').val();
        if (origin === 'credit') {
          return {
            numeric: parseBRLToFloat($creditLimitValueEl.text()),
            formatted: $creditLimitValueEl.text()
          };
        }
        // default: saldo da conta
        return {
          numeric: parseBRLToFloat($balanceValueEl.text()),
          formatted: $balanceValueEl.text()
        };
      }

      // Limpa erro visual do campo de valor
      function clearAmountError() {
        if (amountErrorTimeout) {
          clearTimeout(amountErrorTimeout);
          amountErrorTimeout = null;
        }
        $amount.removeClass('field-error');
        $amountAddon.removeClass('field-error-addon');
        $amountError.text('').hide();
      }

      // Mostra erro visual temporário
      function showAmountError(message) {
        clearAmountError();

        $amount.addClass('field-error');
        $amountAddon.addClass('field-error-addon');
        $amountError.text(message).show();

        amountErrorTimeout = setTimeout(function () {
          clearAmountError();
        }, 3000); // 3 segundos
      }

      // Validação do valor vs limite
      function validateAmount() {
        const raw = $amount.val();

        // sem valor digitado
        if (!raw) {
          showAmountError('Informe um valor para saque.');
          return false;
        }

        const numericAmount = parseFloat(
          raw.replace(/\./g, '').replace(',', '.')
        ) || 0;

        if (numericAmount <= 0) {
          showAmountError('Informe um valor maior que zero.');
          return false;
        }

        const limit = getCurrentAvailableLimit();

        if (numericAmount > limit.numeric) {
          showAmountError('Valor máximo para esta origem é ' + limit.formatted + '.');
          return false;
        }

        // tudo ok
        clearAmountError();
        return true;
      }

      // Quando escolher o tipo de chave PIX
      $pixKeyType.on('change', function () {
        const type = $(this).val();

        // Mostra o campo de chave
        $pixKeyContainer.show();

        // Limpa valor e máscaras anteriores
        $pixKey.val('');
        if (typeof $pixKey.unmask === 'function') {
          $pixKey.unmask();
        }

        // Reset de tipo/inputmode
        $pixKey.attr('type', 'text').removeAttr('inputmode');

        switch (type) {
          case 'phone':
            $pixKey.attr('type', 'tel').attr('inputmode', 'numeric');
            $pixKey.mask('(00) 00000-0000');
            break;
          case 'cpf':
            $pixKey.attr('type', 'tel').attr('inputmode', 'numeric');
            $pixKey.mask('000.000.000-00');
            break;
          case 'cnpj':
            $pixKey.attr('type', 'tel').attr('inputmode', 'numeric');
            $pixKey.mask('00.000.000/0000-00');
            break;
          case 'email':
            $pixKey.attr('type', 'email').attr('inputmode', 'email');
            // sem máscara pra e-mail
            break;
          case 'random':
            $pixKey.attr('type', 'text');
            // sem máscara pra chave aleatória
            break;
        }
      });

      // Revalida quando o usuário muda a origem (saldo / crédito)
      $originRadios.on('change', function () {
        if ($amount.val()) {
          validateAmount();
        }
      });

      // Revalida durante a digitação do valor
      $amount.on('input', function () {
        if ($amount.val()) {
          validateAmount();
        } else {
          clearAmountError();
        }
      });

      // Intercepta clique no botão "Sacar" para impedir modal com valor inválido
      $withdrawButton.on('click', function (e) {
        if (!validateAmount()) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
        // se estiver válido, deixa o modal seguir normalmente
        return true;
      });
    });
  </script>

  {% tracking_body_end %}
</body>

</html>
