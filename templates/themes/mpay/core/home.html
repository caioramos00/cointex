{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, viewport-fit=cover" />
  <meta name="description" content="mPay" />
  <meta name="keywords" content="mPay" />
  <meta name="author" content="mPay" />
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <link rel="icon" href="{% static 'assets/images/logo/favicon.png' %}" type="image/x-icon" />
  <title>mPay App</title>
  <link rel="apple-touch-icon" href="{% static 'assets/images/logo/favicon.png' %}" />
  <meta name="theme-color" content="#122636" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="mPay" />

  <!-- Fontes / Ícones / CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="{% static 'assets/css/vendors/iconsax.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'assets/css/vendors/bootstrap.min.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'assets/css/vendors/swiper-bundle.min.css' %}" />
  <link rel="stylesheet" id="change-link" type="text/css" href="{% static 'assets/css/style.css' %}" />

  <!-- PIXELS — replicado da home Cointex -->
  <meta name="facebook-domain-verification" content="73hwg7lythnnqtl0mtlqdgyewx6h3z" />
  <script>
    !function(f,b,e,v,n,t,s) {
      if(f.fbq) return;
      n=f.fbq=function(){n.callMethod? n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq) f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0';
      n.queue=[]; t=b.createElement(e); t.async=!0; t.src=v;
      s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s)
    }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1414661506543941');
    fbq('init', '24796423593276136');
    fbq('init', '780359434541574');
    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1414661506543941&ev=PageView&noscript=1"/>
    <img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=24796423593276136&ev=PageView&noscript=1"/>
    <img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=780359434541574&ev=PageView&noscript=1"/>
  </noscript>
</head>

<body class="theme-body">
  <!-- Sidebar -->
  <div class="offcanvas sidebar-offcanvas offcanvas-start" tabindex="-1" id="offcanvasLeft">
    <div class="offcanvas-header sidebar-header">
      <div class="sidebar-logo">
        <img class="img-fluid logo" src="{% static 'assets/images/logo/logo.png' %}" alt="logo" />
      </div>
      <div class="balance">
        <img class="img-fluid balance-bg" src="{% static 'assets/images/background/auth-bg.jpg' %}" alt="auth-bg" />
        <h5>Saldo</h5>
        <h2>R$ {{ user_balance|default:"0,00" }}</h2>
      </div>
    </div>
    <div class="offcanvas-body">
      <div class="sidebar-content">
        <ul class="link-section">
          <li>
            <a href="#/landing" class="pages" data-route="landing">
              <i class="sidebar-icon" data-feather="credit-card"></i>
              <h3>mPay</h3>
            </a>
          </li>
          <li>
            <a href="#/crypto" class="pages" data-route="crypto">
              <i class="sidebar-icon" data-feather="dollar-sign"></i>
              <h3>Cripto</h3>
            </a>
          </li>
          <li>
            <a href="#/insight" class="pages" data-route="insight">
              <i class="sidebar-icon" data-feather="bar-chart-2"></i>
              <h3>Insights</h3>
            </a>
          </li>
          <li>
            <a href="#/profile" class="pages" data-route="profile">
              <i class="sidebar-icon" data-feather="user"></i>
              <h3>Perfil</h3>
            </a>
          </li>
          <li>
            <a href="{% url 'logout' %}" class="pages">
              <i class="sidebar-icon" data-feather="log-out"></i>
              <h3>Sair</h3>
            </a>
          </li>
        </ul>

        <div class="mode-switch">
          <ul class="switch-section">
            <!-- REMOVIDO: RTL -->
            <li>
              <h3>Tema escuro</h3>
              <div class="switch-btn">
                <input id="dark-switch" type="checkbox" />
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Cabeçalho dinâmico -->
  <header class="section-t-space">
    <div class="custom-container">
      <div class="header-panel">
        <a class="sidebar-btn" data-bs-toggle="offcanvas" data-bs-target="#offcanvasLeft">
          <i class="menu-icon" data-feather="menu"></i>
        </a>
        <h2 id="spa-title">mPay</h2>
        <a href="#/scan" class="notification" id="spa-right-action" aria-label="Ação">
          <i class="notification-icon" data-feather="bell"></i>
        </a>
      </div>
    </div>
  </header>

  <!-- Seções SPA -->
  <main id="spa-root">
    <section id="route-landing" class="spa-route" data-title="mPay" aria-labelledby="spa-title">
      {% include "themes/mpay/core/spa/_landing.html" %}
    </section>

    <section id="route-crypto" class="spa-route d-none" data-title="Cripto" aria-labelledby="spa-title">
      {% include "themes/mpay/core/spa/_crypto.html" %}
    </section>

    <section id="route-insight" class="spa-route d-none" data-title="Insights" aria-labelledby="spa-title">
      {% include "themes/mpay/core/spa/_insight.html" %}
    </section>

    <section id="route-profile" class="spa-route d-none" data-title="Perfil" aria-labelledby="spa-title">
      {% include "themes/mpay/core/spa/_profile.html" %}
    </section>
  </main>

  <!-- Navbar inferior -->
  <div class="navbar-menu">
    <div class="scanner-bg">
      <a href="#/scan" class="scanner-btn">
        <img class="img-fluid" src="{% static 'assets/images/svg/scan.svg' %}" alt="scan" />
      </a>
    </div>
    <ul id="bottom-nav">
      <li data-route="landing" class="active">
        <a href="#/landing">
          <div class="icon">
            <img class="unactive" src="{% static 'assets/images/svg/mpay.svg' %}" alt="mPay" />
            <img class="active" src="{% static 'assets/images/svg/mpay-fill.svg' %}" alt="mPay" />
          </div>
          <h5>mPay</h5>
        </a>
      </li>
      <li data-route="crypto">
        <a href="#/crypto">
          <div class="icon">
            <img class="unactive" src="{% static 'assets/images/svg/bitcoin.svg' %}" alt="cripto" />
            <img class="active" src="{% static 'assets/images/svg/bitcoin-fill.svg' %}" alt="cripto" />
          </div>
          <h5>Cripto</h5>
        </a>
      </li>
      <li></li>
      <li data-route="insight">
        <a href="#/insight">
          <div class="icon">
            <img class="unactive" src="{% static 'assets/images/svg/bar-chart.svg' %}" alt="insights" />
            <img class="active" src="{% static 'assets/images/svg/bar-chart-fill.svg' %}" alt="insights" />
          </div>
          <h5>Insights</h5>
        </a>
      </li>
      <li data-route="profile">
        <a href="#/profile">
          <div class="icon">
            <img class="unactive" src="{% static 'assets/images/svg/user.svg' %}" alt="perfil" />
            <img class="active" src="{% static 'assets/images/svg/user-fill.svg' %}" alt="perfil" />
          </div>
          <h5>Perfil</h5>
        </a>
      </li>
    </ul>
  </div>

  <!-- Espaço painel -->
  <section class="panel-space"></section>

  <!-- JS vendors -->
  <script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
  <script src="{% static 'assets/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'assets/js/feather.min.js' %}"></script>
  <script src="{% static 'assets/js/swiper-bundle.min.js' %}"></script>
  <script src="{% static 'js/chart.bundle.min.js' %}"></script>
  <script src="{% static 'js/line-chart.js' %}"></script>
  <script src="{% static 'assets/js/apexcharts.min.js' %}"></script>
  <script src="{% static 'assets/js/main.js' %}"></script>

  <!-- Disparos equivalentes ao Cointex -->
  {% if track_complete_registration %}
  <script> fbq('track', 'CompleteRegistration'); </script>
  {% endif %}
  <script> fbq('track', 'ViewContent', {value: {{ user_balance|default:0 }}, currency: 'BRL'}); </script>

  <!-- SPA Router / Dark Mode / Pixels virtuais -->
  <script>
    (function () {
      const routes = ['landing','crypto','insight','profile'];
      const $title = document.getElementById('spa-title');
      const $right = document.getElementById('spa-right-action');
      const $sections = routes.reduce((acc, r) => (acc[r] = document.getElementById('route-' + r), acc), {});
      const $bottom = document.getElementById('bottom-nav');

      function setActive(route) {
        routes.forEach(r => {
          const sec = $sections[r];
          if (!sec) return;
          if (r === route) sec.classList.remove('d-none'); else sec.classList.add('d-none');
          const li = $bottom.querySelector('li[data-route="'+r+'"]');
          if (li) li.classList.toggle('active', r === route);
        });
        const current = $sections[route];
        if (current) {
          const t = current.getAttribute('data-title') || 'mPay';
          $title.textContent = t;
          // Re-render feather icons da seção ativa
          if (window.feather) feather.replace();
          // PageView virtual opcional
          if (window.fbq) {
            try {
              fbq('track', 'PageView');
              // fbq('trackCustom','VirtualPageView',{route});
            } catch(e){}
          }
          // Inicializações locais por rota (ex.: sliders/charts)
          if (route === 'landing' && window.initLanding) window.initLanding();
          if (route === 'crypto' && window.initCrypto) window.initCrypto();
          if (route === 'insight' && window.initInsight) window.initInsight();
          if (route === 'profile' && window.initProfile) window.initProfile();
        }
      }

      function getRouteFromHash() {
        const h = (location.hash || '').replace(/^#\/?/, '');
        return routes.includes(h) ? h : 'landing';
      }

      window.addEventListener('hashchange', () => setActive(getRouteFromHash()));
      document.querySelectorAll('a.pages[data-route]').forEach(a => {
        a.addEventListener('click', (e) => {
          // deixar o hash fazer o trabalho; prev default não é necessário
        });
      });

      // Dark mode
      const darkSwitch = document.getElementById('dark-switch');
      const KEY = 'mpay:dark';
      function applyDark(on) {
        document.documentElement.classList.toggle('dark', !!on);
      }
      try {
        const saved = localStorage.getItem(KEY);
        const on = saved ? saved === '1' : true; // default: escuro
        applyDark(on);
        if (darkSwitch) {
          darkSwitch.checked = on;
          darkSwitch.addEventListener('change', () => {
            const v = darkSwitch.checked;
            localStorage.setItem(KEY, v ? '1' : '0');
            applyDark(v);
          });
        }
      } catch(e){}

      // Startup
      if (window.feather) feather.replace();
      setActive(getRouteFromHash());
    })();
  </script>
</body>
</html>
