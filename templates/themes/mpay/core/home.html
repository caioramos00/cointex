{% load static theming %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#122636"/>

  <title>MPay — Início</title>

  {# Manifest/Favicons do tema MPay #}
  <link rel="manifest" href="{% themed_static 'mpay/manifest.json' %}"/>
  <link rel="icon" type="image/png" href="{% themed_static 'images/logo/favicon.png' %}"/>
  <link rel="apple-touch-icon" href="{% themed_static 'images/logo/favicon.png' %}"/>

  {# CSS principais do MPay (extraídos do landing) #}
  <link rel="stylesheet" href="{% themed_static 'css/vendors/iconsax.css' %}"/>
  <link rel="stylesheet" href="{% themed_static 'css/vendors/bootstrap.min.css' %}"/>
  <link rel="stylesheet" href="{% themed_static 'css/vendors/swiper-bundle.min.css' %}"/>
  <link rel="stylesheet" href="{% themed_static 'css/style.css' %}"/>

  {# ApexCharts para os sparklines das moedas (já existe em static/js/apexcharts.js no projeto) #}
  <script defer src="{% static 'js/apexcharts.js' %}"></script>

  {# ======= Facebook Pixel (mesmo bloco do Cointex) ======= #}
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq) return; n=f.fbq=function(){ n.callMethod ?
      n.callMethod.apply(n,arguments) : n.queue.push(arguments) };
      if(!f._fbq) f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0';
      n.queue=[]; t=b.createElement(e); t.async=!0;
      t.src=v; s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

    fbq('init', '1414661506543941');
    fbq('init', '24796423593276136');
    fbq('init', '780359434541574');

    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=1414661506543941&ev=PageView&noscript=1"/>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=24796423593276136&ev=PageView&noscript=1"/>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=780359434541574&ev=PageView&noscript=1"/>
  </noscript>

  {# ======= TikTok Pixel (mesmo do Cointex) ======= #}
  <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];
      ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"];
      ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};
      for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
      ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e};
      ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";
        ttq._i=ttq._i||{}; ttq._i[e]=[]; ttq._i[e]._u=i; ttq._t=ttq._t||{}; ttq._t[e]=+new Date;
        ttq._o=ttq._o||{}; ttq._o[e]=n||{}; var a=d.createElement("script");
        a.type="text/javascript"; a.async=!0; a.src=i+"?sdkid="+e+"&lib="+t;
        var s=d.getElementsByTagName("script")[0]; s.parentNode.insertBefore(a,s);
      };
      ttq.load('D31KIHJC77U0B8UM6JJG'); ttq.page();
    }(window, document, 'ttq');
  </script>
</head>

<body class="bg-body">

  {# ======= Header (MPay) ======= #}
  <header class="header">
    <div class="top-bar">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center py-3">
          <a class="d-flex align-items-center gap-2 text-decoration-none" href="{% url 'core:home' %}">
            <img src="{% themed_static 'images/logo/favicon.png' %}" alt="MPay" width="28" height="28"/>
            <strong class="text-white">MPay</strong>
          </a>
          <nav class="d-flex gap-3">
            <a href="{% url 'core:profile' %}" class="text-white">Perfil</a>
            <a href="{% url 'core:user_info' %}" class="text-white">Conta</a>
          </nav>
        </div>
      </div>
    </div>
  </header>

  {# ======= Saldo + ações rápidas ======= #}
  <section class="py-4">
    <div class="container">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <p class="mb-1 text-muted">Saldo disponível</p>
          <h2 class="mb-3">{{ formatted_balance }}</h2>
          <div class="d-flex gap-2">
            <a href="{% url 'core:send_balance' %}" class="btn btn-primary flex-fill">Enviar</a>
            <a href="{% url 'core:withdraw_balance' %}" class="btn btn-outline-primary flex-fill">Sacar</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  {# ======= Mercado (hot_coins com sparkline) ======= #}
  <section class="pb-4">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0">Mercado</h5>
        <small class="text-muted">24h</small>
      </div>

      <div class="swiper" data-space-between="12" data-preview="2.3" data-tablet="2.6" data-desktop="3">
        <div class="swiper-wrapper">
          {% for coin in hot_coins %}
          <div class="swiper-slide">
            <div class="card h-100 border-0 shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <img src="{{ coin.image }}" alt="{{ coin.symbol|upper }}" width="28" height="28" class="rounded"/>
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between">
                      <strong>{{ coin.name }}</strong>
                      <small class="text-muted">{{ coin.symbol|upper }}</small>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span class="fw-semibold">{{ coin.formatted_current_price }}</span>
                      {% with ch=coin.price_change_percentage_24h %}
                        {% if ch > 0 %}
                          <span class="badge bg-success-subtle text-success">+{{ ch|floatformat:2 }}%</span>
                        {% elif ch < 0 %}
                          <span class="badge bg-danger-subtle text-danger">{{ ch|floatformat:2 }}%</span>
                        {% else %}
                          <span class="badge bg-secondary-subtle text-secondary">0,00%</span>
                        {% endif %}
                      {% endwith %}
                    </div>
                  </div>
                </div>

                {# sparkline #}
                <div id="line-chart-{{ forloop.counter }}" style="height:56px;"></div>
                <script>
                  (function(){
                    var data = {{ coin.sparkline_json|safe }};
                    if (!Array.isArray(data)) return;
                    var options = {
                      series: [{ data: data.slice(-50) }],
                      chart: { type:'line', height:56, sparkline:{enabled:true}, animations:{enabled:false} },
                      stroke: { curve:'smooth', width:1.5, colors:['{{ coin.chart_color }}'] },
                      tooltip: { enabled:false },
                      grid: { show:false },
                      xaxis: { labels:{show:false}, axisBorder:{show:false}, axisTicks:{show:false} },
                      yaxis: { labels:{show:false} }
                    };
                    var el = document.getElementById("line-chart-{{ forloop.counter }}");
                    if (el && window.ApexCharts) { new ApexCharts(el, options).render(); }
                  })();
                </script>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>

  {# ======= Listas secundárias (Top Ganhadores / Populares / Preço) ======= #}
  <section class="pb-6">
    <div class="container">
      <ul class="nav nav-pills mb-3" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-gainers" type="button">Top ganhadores</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-popular" type="button">Populares</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-price" type="button">Maior preço</button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-gainers">
          {% for c in top_gainers %}
          <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
            <div class="d-flex align-items-center gap-2">
              <img src="{{ c.image }}" width="24" height="24" class="rounded" alt="{{ c.symbol|upper }}"/>
              <strong>{{ c.name }}</strong>
              <small class="text-muted">{{ c.symbol|upper }}</small>
            </div>
            <div class="text-end">
              <div class="fw-semibold">{{ c.formatted_current_price }}</div>
              {% with ch=c.price_change_percentage_24h %}
                {% if ch > 0 %}
                  <small class="text-success">+{{ ch|floatformat:2 }}%</small>
                {% elif ch < 0 %}
                  <small class="text-danger">{{ ch|floatformat:2 }}%</small>
                {% else %}
                  <small class="text-muted">0,00%</small>
                {% endif %}
              {% endwith %}
            </div>
          </div>
          {% empty %}
          <p class="text-muted">Sem dados para exibir.</p>
          {% endfor %}
        </div>

        <div class="tab-pane fade" id="tab-popular">
          {% for c in popular_coins %}
          <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
            <div class="d-flex align-items-center gap-2">
              <img src="{{ c.image }}" width="24" height="24" class="rounded" alt="{{ c.symbol|upper }}"/>
              <strong>{{ c.name }}</strong>
              <small class="text-muted">{{ c.symbol|upper }}</small>
            </div>
            <div class="text-end">
              <div class="fw-semibold">{{ c.formatted_current_price }}</div>
              <small class="text-muted">Vol: {{ c.total_volume|default:0|floatformat:0 }}</small>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="tab-pane fade" id="tab-price">
          {% for c in price_coins %}
          <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
            <div class="d-flex align-items-center gap-2">
              <img src="{{ c.image }}" width="24" height="24" class="rounded" alt="{{ c.symbol|upper }}"/>
              <strong>{{ c.name }}</strong>
              <small class="text-muted">{{ c.symbol|upper }}</small>
            </div>
            <div class="text-end">
              <div class="fw-semibold">{{ c.formatted_current_price }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

    </div>
  </section>

  {# ======= Footer simples ======= #}
  <footer class="py-4 bg-dark">
    <div class="container d-flex justify-content-between align-items-center">
      <small class="text-white-50">© MPay</small>
      <a class="text-white-50" href="{% url 'core:profile' %}">Perfil</a>
    </div>
  </footer>

  {# Dispara eventos conforme contexto (como no Cointex) #}
  {% if track_complete_registration %}
  <script> fbq('track', 'CompleteRegistration'); </script>
  {% endif %}
  <script> fbq('track', 'ViewContent', {value: {{ user_balance|default:0 }}, currency: 'BRL'}); </script>

  {# JS do MPay (landing) #}
  <script src="{% themed_static 'js/swiper-bundle.min.js' %}"></script>
  <script src="{% themed_static 'js/custom-swiper.js' %}"></script>
  <script src="{% themed_static 'js/feather.min.js' %}"></script>
  <script src="{% themed_static 'js/custom-feather.js' %}"></script>
  <script src="{% themed_static 'js/iconsax.js' %}"></script>
  <script src="{% themed_static 'js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% themed_static 'js/homescreen-popup.js' %}"></script>
  <script src="{% themed_static 'js/offcanvas-popup.js' %}"></script>
  <script src="{% themed_static 'js/script.js' %}"></script>
</body>
</html>
