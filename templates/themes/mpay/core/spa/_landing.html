{% load theming %}{% load static %}
<!-- card start -->
<section class="section-b-space">
  <div class="custom-container">
    <div class="card-box">
      <div class="card-details">
        <div class="d-flex justify-content-between">
          <h5 class="fw-semibold">Saldo disponível para saque</h5>
          <img src="{% themed_static 'images/svg/ellipse.svg' %}" alt="ellipse" />
        </div>

        <h1 class="mt-2 text-white">{{ user_balance_formatted|default:'R$ 0,00' }}</h1>

        <div class="amount-details">
          <div class="amount w-50 text-start">
            <div class="d-flex align-items-center justify-content-start">
              <img class="img-fluid icon" src="{% themed_static 'images/svg/arrow-down-right.svg' %}" alt="down" />
              <h5>Entradas do mês</h5>
            </div>
            <h3 class="text-white">{{ entradas_formatted|default:'R$ 0,00' }}</h3>
          </div>
          <div class="amount w-50 text-end border-0">
            <div class="d-flex align-items-center justify-content-end">
              <img class="img-fluid icon" src="{% themed_static 'images/svg/arrow-up-right.svg' %}" alt="up" />
              <h5>Saídas do mês</h5>
            </div>
            <h3 class="text-white">{{ saidas_formatted|default:'R$ 0,00' }}</h3>
          </div>
        </div>
      </div>
      <a href="#add-money" class="add-money theme-color" data-bs-toggle="modal">+ Adicionar dinheiro</a>
    </div>
  </div>
</section>
<!-- card end -->

<!-- categories section starts -->
<section class="categories-section section-b-space">
  <div class="custom-container">
    <ul class="categories-list">
<li>
  <a href="javascript:void(0)" class="validation-required">
    <div class="categories-box">
      <i class="categories-icon" data-feather="dollar-sign"></i>
    </div>
    <h5 class="mt-2 text-center">Investir</h5>
  </a>
</li>
<li>
  <a href="javascript:void(0)" class="validation-required">
    <div class="categories-box">
      <i class="categories-icon" data-feather="plus-square"></i>
    </div>
    <h5 class="mt-2 text-center">Crédito</h5>
  </a>
</li>
<li>
  <a href="#/landing">
    <div class="categories-box">
      <i class="categories-icon" data-feather="repeat"></i>
    </div>
    <h5 class="mt-2 text-center">Transferir</h5>
  </a>
</li>
<li>
  <a href="#/landing">
    <div class="categories-box">
      <i class="categories-icon icon1" data-feather="log-in"></i>
    </div>
    <h5 class="mt-2 text-center">Sacar</h5>
  </a>
</li>
    </ul>
  </div>
</section>
<!-- categories section end -->

<!-- service section starts -->
{% comment %} <section>
  <div class="custom-container">
    <div class="title">
      <h2>Pagar contas e serviços</h2>
    </div>
    <div class="row gy-3">
      <div class="col-3">
        <a href="#/landing">
          <div class="service-box"><i class="service-icon" data-feather="activity"></i></div>
          <h5 class="mt-2 text-center dark-text">Energia</h5>
        </a>
      </div>
      <div class="col-3">
        <a href="#/landing">
          <div class="service-box"><i class="service-icon" data-feather="droplet"></i></div>
          <h5 class="mt-2 text-center dark-text">Água</h5>
        </a>
      </div>
      <div class="col-3">
        <a href="#/landing">
          <div class="service-box"><i class="service-icon" data-feather="wifi"></i></div>
          <h5 class="mt-2 text-center dark-text">Internet</h5>
        </a>
      </div>
      <div class="col-3">
        <a href="#/landing">
          <div class="service-box"><i class="service-icon" data-feather="monitor"></i></div>
          <h5 class="mt-2 text-center dark-text">TV</h5>
        </a>
      </div>
      <div class="col-3">
        <a href="#/landing">
          <div class="service-box"><i class="service-icon" data-feather="bar-chart-2"></i></div>
          <h5 class="mt-2 text-center dark-text">Investimento</h5>
        </a>
      </div>
      <div class="col-3">
        <a href="#/landing">
          <div class="service-box"><i class="service-icon" data-feather="tablet"></i></div>
          <h5 class="mt-2 text-center dark-text">Celular</h5>
        </a>
      </div>
      <div class="col-3">
        <a href="#/landing">
          <div class="service-box"><i class="service-icon" data-feather="plus-square"></i></div>
          <h5 class="mt-2 text-center dark-text">Saúde</h5>
        </a>
      </div>
      <div class="col-3">
        <a href="#/landing">
          <div class="service-box"><i class="service-icon" data-feather="more-horizontal"></i></div>
          <h5 class="mt-2 text-center dark-text">Outros</h5>
        </a>
      </div>
    </div>
  </div>
</section> {% endcomment %}
<!-- service section end -->

<!-- Transaction section starts -->
<section>
  <div class="custom-container">
    <div class="title">
      <h2>Histórico</h2>
      <a href="#/landing">Ver tudo</a>
    </div>

    <div class="row gy-3">
      <div class="col-12">
        <div class="transaction-box">
          <a href="#/landing" class="d-flex gap-3">
            <div class="transaction-image">
              <img class="img-fluid transaction-icon" src="{% themed_static 'images/svg/1.svg' %}" alt="p1" />
            </div>
            <div class="transaction-details">
              <div class="transaction-name">
                <h5>Amazon Prime</h5>
                <h3 class="error-color">R$ 199,<span>99</span></h3>
              </div>
              <div class="d-flex justify-content-between">
                <h5 class="light-text">Assinatura</h5>
                <h5 class="light-text">08:45</h5>
              </div>
            </div>
          </a>
        </div>
      </div>

      <div class="col-12">
        <div class="transaction-box">
          <a href="#/landing" class="d-flex gap-3">
            <div class="transaction-image">
              <img class="img-fluid transaction-icon" src="{% themed_static 'images/svg/2.svg' %}" alt="p2" />
            </div>
            <div class="transaction-details">
              <div class="transaction-name">
                <h5>Apple Store</h5>
                <h3 class="success-color">R$ 60,<span>30</span></h3>
              </div>
              <div class="d-flex justify-content-between">
                <h5 class="light-text">Parcelado</h5>
                <h5 class="light-text">21:00</h5>
              </div>
            </div>
          </a>
        </div>
      </div>

      <div class="col-12">
        <div class="transaction-box">
          <a href="#/landing" class="d-flex gap-3">
            <div class="transaction-image">
              <img class="img-fluid transaction-icon" src="{% themed_static 'images/svg/3.svg' %}" alt="p3" />
            </div>
            <div class="transaction-details">
              <div class="transaction-name">
                <h5>Mercado</h5>
                <h3 class="error-color">R$ 55,<span>20</span></h3>
              </div>
              <div class="d-flex justify-content-between">
                <h5 class="light-text">Compra</h5>
                <h5 class="light-text">20 mai</h5>
              </div>
            </div>
          </a>
        </div>
      </div>

      <div class="col-12">
        <div class="transaction-box">
          <a href="#/landing" class="d-flex gap-3">
            <div class="transaction-image">
              <img class="img-fluid transaction-icon" src="{% themed_static 'images/svg/4.svg' %}" alt="p4" />
            </div>
            <div class="transaction-details">
              <div class="transaction-name">
                <h5>Snapchat</h5>
                <h3 class="success-color">R$ 18,<span>10</span></h3>
              </div>
              <div class="d-flex justify-content-between">
                <h5 class="light-text">Boleto</h5>
                <h5 class="light-text">19 mai</h5>
              </div>
            </div>
          </a>
        </div>
      </div>

      <div class="col-12">
        <div class="transaction-box">
          <a href="#/landing" class="d-flex gap-3">
            <div class="transaction-image">
              <img class="img-fluid transaction-icon" src="{% themed_static 'images/svg/5.svg' %}" alt="p5" />
            </div>
            <div class="transaction-details">
              <div class="transaction-name">
                <h5>Spotify</h5>
                <h3 class="success-color">R$ 20,<span>50</span></h3>
              </div>
              <div class="d-flex justify-content-between">
                <h5 class="light-text">Transferência</h5>
                <h5 class="light-text">18 mai</h5>
              </div>
            </div>
          </a>
        </div>
      </div>

    </div>
  </div>
</section>
<!-- Transaction section end -->

<!-- quick send section starts -->
{% comment %} <section>
  <div class="custom-container">
    <div class="title">
      <h2>Enviar rapidamente para</h2>
      <a href="#/landing">Ver tudo</a>
    </div>
  </div>
  <div class="quick-send">
    <div class="profile">
      <a href="#/landing" class="profile new-profile">
        <div class="new-image"><i class="icon" data-feather="plus"></i></div>
      </a>
    </div>

    <div class="profile">
      <a href="#/landing">
        <img class="img-fluid person-img" src="{% themed_static 'images/person/p1.png' %}" alt="p1" />
      </a>
      <h5>Mike</h5>
    </div>

    <div class="profile">
      <a href="#/landing">
        <img class="img-fluid person-img" src="{% themed_static 'images/person/p2.png' %}" alt="p2" />
        <h5>Michael</h5>
      </a>
    </div>

    <div class="profile">
      <a href="#/landing">
        <img class="img-fluid person-img" src="{% themed_static 'images/person/p3.png' %}" alt="p3" />
        <h5>Kristin</h5>
      </a>
    </div>

    <div class="profile">
      <a href="#/landing">
        <img class="img-fluid person-img" src="{% themed_static 'images/person/p4.png' %}" alt="p4" />
        <h5>Trunk</h5>
      </a>
    </div>

    <div class="profile">
      <a href="#/landing">
        <img class="img-fluid person-img" src="{% themed_static 'images/person/p5.png' %}" alt="p5" />
        <h5>Johnny</h5>
      </a>
    </div>
  </div>
</section> {% endcomment %}
<!-- quick send section end -->

<!-- all cards section starts (alinhado ao original) -->
<section>
  <div class="custom-container">
    <div class="title">
      <h2>Cartões de crédito</h2>
      <a href="#/landing">Ver tudo</a>
    </div>

    <div class="swiper card-slider">
      <div class="swiper-wrapper">
        <div class="swiper-slide">
          <div class="credit-card-box color1">
            <div class="card-logo">
              <img class="img-fluid" src="{% themed_static 'images/svg/logo1.svg' %}" alt="logo1" />
              <img class="img-fluid" src="{% themed_static 'images/svg/card-chip.svg' %}" alt="card-chip" />
            </div>
            <h6 class="card-number">**** **** **** 2563</h6>
            <h5 class="card-name">Survana Williams</h5>
            <h2 class="card-amount">R$ 25.000,89</h2>
            <div class="d-block">
              <div class="card-date w-100">
                <h6>Validade</h6>
                <h6>CVV</h6>
              </div>
              <div class="card-numbers w-100">
                <h6 class="text-white fw-semibold mt-1">12 /24</h6>
                <h6 class="text-white fw-semibold mt-1">***</h6>
              </div>
            </div>
          </div>
        </div>

        <div class="swiper-slide">
          <div class="credit-card-box color2">
            <div class="card-logo">
              <img class="img-fluid" src="{% themed_static 'images/svg/logo1.svg' %}" alt="logo1" />
              <img class="img-fluid" src="{% themed_static 'images/svg/card-chip.svg' %}" alt="card-chip" />
            </div>
            <h6 class="card-number">**** **** **** 2563</h6>
            <h5 class="card-name">Survana Williams</h5>
            <h2 class="card-amount">R$ 25.000,89</h2>
            <div class="d-block">
              <div class="card-date w-100">
                <h6>Validade</h6>
                <h6>CVV</h6>
              </div>
              <div class="card-numbers w-100">
                <h6 class="text-white fw-semibold mt-1">12 /24</h6>
                <h6 class="text-white fw-semibold mt-1">***</h6>
              </div>
            </div>
          </div>
        </div>

        <div class="swiper-slide">
          <div class="credit-card-box color3">
            <div class="card-logo">
              <img class="img-fluid" src="{% themed_static 'images/svg/logo1.svg' %}" alt="logo1" />
              <img class="img-fluid" src="{% themed_static 'images/svg/card-chip.svg' %}" alt="card-chip" />
            </div>
            <h6 class="card-number">**** **** **** 2563</h6>
            <h5 class="card-name">Survana Williams</h5>
            <h2 class="card-amount">R$ 25.000,89</h2>
            <div class="d-block">
              <div class="card-date w-100">
                <h6>Validade</h6>
                <h6>CVV</h6>
              </div>
              <div class="card-numbers w-100">
                <h6 class="text-white fw-semibold mt-1">12 /24</h6>
                <h6 class="text-white fw-semibold mt-1">***</h6>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- swiper-wrapper -->
    </div> <!-- swiper -->
  </div>
</section>
<!-- all cards section end -->

<!-- bill details section starts -->
<section>
  <div class="custom-container">
    <div class="title">
      <h2>Contas em débito automático</h2>
      <a href="#/landing">Ver tudo</a>
    </div>
    <div class="row g-3">
      <div class="col-md-3 col-6">
        <div class="bill-box">
          <div class="d-flex gap-3">
            <div class="bill-icon">
              <img class="img-fluid icon" src="{% themed_static 'images/svg/6.svg' %}" alt="p6" />
            </div>
            <div class="bill-details">
              <h5 class="dark-text">Airtel</h5>
              <h6 class="light-text mt-2">Pré-pago</h6>
            </div>
          </div>
          <div class="bill-price">
            <h5>R$ 69,49</h5>
            <a href="#pay" data-bs-toggle="modal" class="btn bill-pay bill-paid">Pagar</a>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-6">
        <div class="bill-box">
          <div class="d-flex gap-3">
            <div class="bill-icon">
              <img class="img-fluid icon" src="{% themed_static 'images/svg/7.svg' %}" alt="p7" />
            </div>
            <div class="bill-details">
              <h5 class="dark-text">Apple</h5>
              <h6 class="light-text mt-2">Assinatura</h6>
            </div>
          </div>
          <div class="bill-price">
            <h5>R$ 49,85</h5>
            <a href="#pay" data-bs-toggle="modal" class="btn bill-pay bill-paid">Pagar</a>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-6">
        <div class="bill-box">
          <div class="d-flex gap-3">
            <div class="bill-icon">
              <img class="img-fluid icon" src="{% themed_static 'images/svg/8.svg' %}" alt="p8" />
            </div>
            <div class="bill-details">
              <h5 class="dark-text">TV</h5>
              <h6 class="light-text mt-2">Conexão</h6>
            </div>
          </div>
          <div class="bill-price">
            <h5>R$ 99,99</h5>
            <a href="#pay" data-bs-toggle="modal" class="btn bill-pay bill-paid">Pagar</a>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-6">
        <div class="bill-box">
          <div class="d-flex gap-3">
            <div class="bill-icon">
              <img class="img-fluid icon" src="{% themed_static 'images/svg/9.svg' %}" alt="p9" />
            </div>
            <div class="bill-details">
              <h5 class="dark-text">Torrent</h5>
              <h6 class="light-text mt-2">Energia</h6>
            </div>
          </div>
          <div class="bill-price">
            <h5>R$ 60,49</h5>
            <a href="#pay" data-bs-toggle="modal" class="btn bill-pay bill-paid">Pagar</a>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>
<!-- bill details section end -->

<!-- saving plans section starts -->
<section>
  <div class="custom-container">
    <div class="title">
      <h2>Poupança</h2>
      <a href="#/landing">Ver tudo</a>
    </div>
    <div class="row">
      <div class="col-6">
        <div class="saving-plan-box">
          <div class="saving-plan-icon">
            <img class="img-fluid" src="{% themed_static 'images/svg/10.svg' %}" alt="p10" />
          </div>
          <h3>Novo carro</h3>
          <h6>Valor restante</h6>
          <div class="progress" role="progressbar" aria-label="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar bar1"></div>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <h5 class="theme-color">R$ 2.000,00</h5>
            <img class="img-fluid arrow" src="{% themed_static 'images/svg/arrow.svg' %}" alt="arrow" />
          </div>
        </div>
      </div>

      <div class="col-6">
        <div class="saving-plan-box">
          <div class="saving-plan-icon">
            <img class="img-fluid" src="{% themed_static 'images/svg/11.svg' %}" alt="p11" />
          </div>
          <h3>Casa grande</h3>
          <h6>Valor restante</h6>
          <div class="progress" role="progressbar" aria-label="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar bar2"></div>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <h5 class="theme-color">R$ 2.000,00</h5>
            <img class="img-fluid arrow" src="{% themed_static 'images/svg/arrow.svg' %}" alt="arrow" />
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- saving plans section end -->

<!-- monthly statistics section starts -->
<section>
  <div class="custom-container">
    <div class="statistics-banner">
      <div class="d-flex justify-content-center gap-3">
        <div class="statistics-image">
          <i class="icon" data-feather="bar-chart-2"></i>
        </div>
        <div class="statistics-content d-block">
          <h5>Estatísticas mensais</h5>
          <h6>30% melhor desempenho que o período anterior</h6>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- monthly statistics section end -->

<!-- REMOVIDO: seção de notícias -->
<!-- (news-update) -->
<!-- ==================== MODAIS E OFFCANVAS ==================== -->

<!-- ==================== MODAL DE DEPÓSITO ==================== -->

<!-- add money modal start -->
<div class="modal add-money-modal fade" id="add-money" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Adicionar dinheiro</h2>
      </div>

      <!-- Etapa 1: Formulário -->
      <div class="modal-body" id="step-form">
        <div class="form-group mb-3">
          <label class="form-label mb-2">Forma de pagamento</label>
          <select class="form-select" disabled>
            <option>PIX</option>
          </select>
        </div>

        <div class="form-group mb-3">
          <label class="form-label mb-2">Valor</label>
          <!-- teclado numérico em mobile + melhor UX -->
          <input 
            type="text" 
            inputmode="decimal" 
            class="form-control" 
            id="inputamount" 
            placeholder="R$ 0,00" 
            autocomplete="off">
          <div id="deposit-error" class="text-danger fw-bold mt-2 d-none"></div>
        </div>

        <button type="button" class="btn theme-btn w-100" id="btn-depositar">
          <span class="spinner-border spinner-border-sm me-2 d-none"></span>
          Depositar
        </button>
      </div>

      <!-- Etapa 2: PIX gerado -->
      <div class="modal-body d-none" id="step-pix">
        <div class="text-center px-3 py-4">

          <!-- QR Code -->
          <div id="qrcode-div" class="mx-auto mb-4" style="width: 260px; height: 260px; background:#fff; border-radius:14px;"></div>

          <!-- Valor grande -->
          <h3 class="mb-2 fw-bold" id="pix-amount"></h3>

          <!-- Timer preto e bold -->
          <p class="text-muted mb-4">
            Expira em <span id="pix-timer" class="fw-bold text-dark">30:00</span>
          </p>

<!-- PIX copia e cola – simples, 70/30, mesma altura -->
<div class="mb-3 px-3">
  <div class="input-group" style="width: 100%; flex-wrap: wrap-reverse;">

    <!-- campo 70% -->
    <input
      type="text"
      id="copia-e-cola"
      readonly
      class="form-control"
      style="
        flex: 0 0 70%;
        max-width: 70%;
        height: 48px !important;
        font-size: 0.85rem;
        letter-spacing: 0.04em;
      "
    >

    <!-- botão 30% -->
    <button
      type="button"
      id="btn-copy"
      class="btn text-white d-flex align-items-center justify-content-center"
      style="
        flex: 0 0 30%;
        max-width: 30%;
        height: 48px !important;
        background: rgba(98, 44, 253, 1);
        border-color: rgba(98, 44, 253, 1);
        padding: 0 8px;
        font-size: 0.85rem;
        font-weight: 600;
      "
    >
      <i data-feather="copy" class="me-1" style="width:16px;height:16px;"></i>
      Copiar
    </button>

  </div>
</div>

          <!-- Status -->
          <div id="pix-status" class="alert alert-warning py-2 small">Aguardando pagamento...</div>
        </div>
      </div>

      <div class="modal-body d-none" id="step-validation">
        <div class="text-center px-4 py-5">
          <i data-feather="smartphone" style="width: 80px; height: 80px; color: var(--theme-color);"></i>
          <h2 class="mt-4 fw-bold">Novo dispositivo detectado</h2>
          <p class="mt-3 px-3">Para sua segurança, identificamos que você está acessando a conta de um dispositivo ou navegador ainda não registrado.</p>
          <div class="mt-4">
            <button type="button" class="btn theme-btn w-100" data-bs-dismiss="modal">Validar conta</button>
          </div>
        </div>
      </div>

      <button type="button" class="btn close-btn" data-bs-dismiss="modal">
        <i class="icon" data-feather="x"></i>
      </button>
    </div>
  </div>
</div>
<!-- add money modal end -->

<!-- pay modal starts -->
<div class="modal pay-modal fade" id="pay" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Detalhe da conta Apple</h2>
      </div>
      <div class="modal-body">
        <ul class="details-list">
          <li><h3 class="fw-normal dark-text">Valor</h3><h3 class="fw-semibold theme-color">R$ 49,85</h3></li>
          <li><h3 class="fw-normal dark-text">Data da fatura</h3><h3 class="fw-normal light-text">10 mai, 2023</h3></li>
          <li><h3 class="fw-normal dark-text">Vencimento</h3><h3 class="fw-normal error-color">31 mai, 2023</h3></li>
          <li><h3 class="fw-normal dark-text">Nº da fatura</h3><h3 class="fw-normal light-text">BM452695523</h3></li>
          <li><h3 class="fw-normal dark-text">Telefone</h3><h3 class="fw-normal light-text">+55 ***** **256</h3></li>
          <li><h3 class="fw-normal dark-text">Status</h3><h3 class="fw-semibold error-color">Em aberto</h3></li>
        </ul>
        <a href="#/landing" class="btn theme-btn successfully w-100">Pagar</a>
      </div>
      <button type="button" class="btn close-btn" data-bs-dismiss="modal">
        <i class="icon" data-feather="x"></i>
      </button>
    </div>
  </div>
</div>
<!-- pay modal end -->

<!-- paid modal starts -->
<div class="modal pay-modal fade" id="paid" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Detalhe da conta Mobile</h2>
      </div>
      <div class="modal-body">
        <ul class="details-list">
          <li><h3 class="fw-normal dark-text">Valor</h3><h3 class="fw-semibold theme-color">R$ 69,49</h3></li>
          <li><h3 class="fw-normal dark-text">Data da fatura</h3><h3 class="fw-normal light-text">10 mai, 2023</h3></li>
          <li><h3 class="fw-normal dark-text">Vencimento</h3><h3 class="fw-normal light-text">22 mai, 2023</h3></li>
          <li><h3 class="fw-normal dark-text">Nº da fatura</h3><h3 class="fw-normal light-text">BM452695523</h3></li>
          <li><h3 class="fw-normal dark-text">Telefone</h3><h3 class="fw-normal light-text">+55 ***** **256</h3></li>
          <li><h3 class="fw-normal dark-text">Status</h3><h3 class="fw-semibold theme-color">Pago</h3></li>
        </ul>
        <a href="#/landing" class="btn theme-btn successfully w-100">Pago — obrigado!</a>
      </div>
      <button type="button" class="btn close-btn" data-bs-dismiss="modal">
        <i class="icon" data-feather="x"></i>
      </button>
    </div>
  </div>
</div>
<!-- paid modal end -->

<!-- pwa install app popup (offcanvas) -->
<div class="offcanvas offcanvas-bottom addtohome-popup theme-offcanvas" tabindex="-1" id="offcanvas">
  <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  <div class="offcanvas-body small">
    <div class="app-info">
      <img src="{% themed_static 'images/logo/48.png' %}" class="img-fluid" alt="" />
      <div class="content">
        <h4>mPay App</h4>
        <a href="#">www.mPay-app.com</a>
      </div>
    </div>
    <a href="#!" class="btn theme-btn install-app btn-inline home-screen-btn m-0" id="installapp">Adicionar à tela inicial</a>
  </div>
</div>
<!-- pwa offcanvas end -->

<script src="https://unpkg.com/imask@7/dist/imask.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
  const modalEl = document.getElementById('add-money');
  const modal = new bootstrap.Modal(modalEl);
  const modalTitle = modalEl.querySelector('.modal-title');
  const stepForm = document.getElementById('step-form');
  const stepPix = document.getElementById('step-pix');
  const stepValidation = document.getElementById('step-validation');
  const btnDepositar = document.getElementById('btn-depositar');
  const errorEl = document.getElementById('deposit-error');

  let openingForValidation = false; // ← flag que resolve o conflito

  const mask = IMask(document.getElementById('inputamount'), {
    mask: 'R$ num',
    blocks: {
      num: {
        mask: Number,
        thousandsSeparator: '.',
        scale: 2,
        radix: ',',
        padFractionalZeros: true,
        normalizeZeros: true
      }
    }
  });

  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.classList.remove('d-none');
  }

  function hideError() {
    errorEl.classList.add('d-none');
    errorEl.textContent = '';
  }

  let timerInterval = null;
  let pollInterval = null;

  function resetToDeposit() {
    modalTitle.textContent = 'Adicionar dinheiro';
    stepForm.classList.remove('d-none');
    stepPix.classList.add('d-none');
    stepValidation.classList.add('d-none');
    mask.value = '';
    hideError();
    btnDepositar.disabled = false;
    btnDepositar.querySelector('.spinner-border').classList.add('d-none');
    if (timerInterval) clearInterval(timerInterval);
    if (pollInterval) clearInterval(pollInterval);
  }

  // Reset só quando NÃO for abertura para validação
  modalEl.addEventListener('show.bs.modal', () => {
    if (!openingForValidation) {
      resetToDeposit();
    }
    openingForValidation = false; // sempre limpa a flag
  });

  // Sempre volta ao estado de depósito ao fechar
  modalEl.addEventListener('hidden.bs.modal', () => {
    resetToDeposit();
  });

  // ==== DEPÓSITO PIX (100% original) ====
  btnDepositar.addEventListener('click', async () => {
    hideError();
    btnDepositar.disabled = true;
    btnDepositar.querySelector('.spinner-border').classList.remove('d-none');

    const unmasked = mask.unmaskedValue.replace(/\s/g, '');
    const amount = parseFloat(unmasked);

    if (isNaN(amount) || amount <= 0) {
      showError('Insira um valor válido');
      btnDepositar.disabled = false;
      btnDepositar.querySelector('.spinner-border').classList.add('d-none');
      return;
    }

    if (amount < 1) {
      showError('O valor mínimo para depósito é R$ 1,00');
      btnDepositar.disabled = false;
      btnDepositar.querySelector('.spinner-border').classList.add('d-none');
      return;
    }

    if (amount > 2000) {
      showError('O valor máximo para depósito é R$ 2.000,00');
      btnDepositar.disabled = false;
      btnDepositar.querySelector('.spinner-border').classList.add('d-none');
      return;
      return;
    }

    try {
      const response = await fetch('/payments/api/pix/deposit/create/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ amount: amount.toFixed(2) })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.detail || 'Erro ao gerar Pix');
      }

      const qrDiv = document.getElementById('qrcode-div');
      qrDiv.innerHTML = '';
      new QRCode(qrDiv, {
        text: data.copia_e_cola,
        width: 260,
        height: 260,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });

      document.getElementById('pix-amount').textContent = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(data.amount);

      document.getElementById('copia-e-cola').value = data.copia_e_cola;

      const expires = new Date(data.expires_at);
      timerInterval = setInterval(() => {
        const diff = Math.floor((expires - new Date()) / 1000);
        if (diff <= 0) {
          clearInterval(timerInterval);
          document.getElementById('pix-status').textContent = 'Pix expirado';
          document.getElementById('pix-status').classList.replace('alert-warning', 'alert-danger');
          return;
        }
        const m = String(Math.floor(diff / 60)).padStart(2, '0');
        const s = String(diff % 60).padStart(2, '0');
        document.getElementById('pix-timer').textContent = `${m}:${s}`;
      }, 1000);

      stepForm.classList.add('d-none');
      stepPix.classList.remove('d-none');

      pollInterval = setInterval(async () => {
        try {
          const r = await fetch(`/payments/api/pix/deposit/${data.id}/status/`);
          const st = await r.json();
          if (st.paid) {
            clearInterval(pollInterval);
            clearInterval(timerInterval);
            document.getElementById('pix-status').textContent = 'Pagamento confirmado!';
            document.getElementById('pix-status').classList.replace('alert-warning', 'alert-success');
            setTimeout(() => {
              modal.hide();
              location.reload();
            }, 2000);
          }
        } catch (e) {}
      }, 4000);

    } catch (err) {
      showError(err.message || 'Erro ao gerar o Pix. Tente novamente.');
      btnDepositar.disabled = false;
      btnDepositar.querySelector('.spinner-border').classList.add('d-none');
    }
  });

  // ==== VALIDAÇÃO AO CLICAR EM INVESTIR/CRÉDITO ====
  document.querySelectorAll('.validation-required').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      e.stopPropagation();

      openingForValidation = true; // ← ativa a flag

      modalTitle.textContent = 'Validação de segurança';
      stepForm.classList.add('d-none');
      stepPix.classList.add('d-none');
      stepValidation.classList.remove('d-none');

      modal.show();

      setTimeout(() => feather.replace(), 300);
    });
  });

  // Botão copiar PIX
  document.getElementById('btn-copy')?.addEventListener('click', () => {
    const input = document.getElementById('copia-e-cola');
    input.select();
    document.execCommand('copy');
    const btn = document.getElementById('btn-copy');
    const old = btn.innerHTML;
    btn.innerHTML = '<i data-feather="check" class="me-1"></i> Copiado!';
    feather.replace();
    setTimeout(() => {
      btn.innerHTML = old;
      feather.replace();
    }, 2000);
  });
});
</script>